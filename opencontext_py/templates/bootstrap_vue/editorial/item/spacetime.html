{% load humanize %}

<!-- 
NOTE: Templates and view components to edit an item's manifest object.
-->

<style>
 .spacetime_row {
   margin-top: 24px;
   margin-bottom: 24px;
 }
</style>

<template id='act-map'>
  <div v-if="spacetime.feature">          
    <l-map
      style="min-height: 300px;"
      :ref="'map-' + spacetime.uuid" 
      :zoom="spacetime.map_config.zoom"
      :center="spacetime.map_config.center"
      :load-tiles-while-animating="true" 
      :load-tiles-while-interacting="true">
      <l-control-layers position="topright"></l-control-layers>
      <l-tile-layer
        v-for="tp in tileProviders"
        :key="tp.name"
        :name="tp.name"
        :visible="tp.visible"
        :url="tp.url"
        :attribution="tp.attribution"
        layer-type="base"></l-tile-layer>
      <l-geo-json
        :key="'geojson-' + spacetime.uuid + map_key"
        :ref="'geojson-' + spacetime.uuid"
        :options="options"
        :geojson="spacetime.feature"
      >
        </l-popup>
      </l-geo-json>
    </l-map>
  </div>
</template>


<template id="spacetime-form">
  <div>

    <b-row>
      <b-col>
        <label :for="'earliest-' + spacetime.uuid">Early Date</label>
        <b-form-input
          v-model="spacetime.earliest"
          :id="'earliest-' + spacetime.uuid"
          type="number"
          @change="value_change"
          :value="spacetime.earliest"
        ></b-form-input>
      </b-col>
    </b-row>

    <b-row>
      <b-col>
        <label :for="'latest-' + spacetime.uuid">Late Date</label>
        <b-form-input
          v-model="spacetime.latest"
          :id="'latest-' + spacetime.uuid"
          type="number"
          @change="value_change"
          :value="spacetime.latest"
        ></b-form-input>
      </b-col>
    </b-row>

    <b-row>
      <b-col>
        <label :for="'lat-' + spacetime.uuid">Latitude</label>
        <b-form-input
          v-model="spacetime.latitude"
          :id="'lat-' + spacetime.uuid"
          type="number"
          @change="value_change"
          :value="spacetime.latitude"
        ></b-form-input>
      </b-col>
    </b-row>

    <b-row>
      <b-col>
        <label :for="'lon-' + spacetime.uuid">Longitude</label>
        <b-form-input
          v-model="spacetime.longitude"
          :id="'lon-' + spacetime.uuid"
          type="number"
          @change="value_change"
          :value="spacetime.longitude"
        ></b-form-input>
      </b-col>
    </b-row>

    <b-row>
      <b-col>
        <label :for="'geometry-' + spacetime.uuid">Geometry</label>
        <b-form-textarea
          :id="'geometry-' + spacetime.uuid"
          debounce="250"
          @change="value_change"
          v-model="spacetime.geometry"
          :value="spacetime.geometry"
        ></b-form-textarea>
      </b-col>
    </b-row>

    <b-row>

      <b-col v-if="!add_new">
        <b-spinner v-if="updating" label="Updating..."></b-spinner>
        <b-button
          v-if="is_value_changed && !updating"
          sm
          block
          @click="update_spacetime"
          class="text-center"
          variant="info">Update <b-icon-cloud-check-fill></b-icon-cloud-check-fill>
        </b-button>
      </b-col>
      <b-col v-if="add_new">
        <b-spinner v-if="updating" label="Adding..."></b-spinner>
        <b-button
          v-if="is_value_changed && !updating"
          sm
          block
          @click="add_spacetime"
          class="text-center"
          variant="info">Add <b-icon-cloud-check-fill></b-icon-cloud-check-fill>
        </b-button>
      </b-col>

    </b-row>

  </div>
</template>


<template id="spacetime-obj">
  <b-row class="spacetime_row" v-if="spacetime">

    <b-col cols="1">
      <b-button
        sm
        @click="delete_spacetime"
        variant="dark"
        title="Delete location / chronology record"
        class="text-center"><small>Delete <b-icon-x-circle></b-icon-x-circle></small>
      </b-button>
    </b-col>

    <b-col cols="5">

      <spacetime-form
        @edit_spacetime="edit_spacetime($event)"
        v-bind:spacetime="spacetime">
      </spacetime-form>

    </b-col>

    <b-col cols="6">
      <act-map
        v-bind:map_key="map_key"
        v-bind:spacetime="spacetime"></act-map>
    </b-col>

  </b-row>
</template>


<template id="edit-spacetime">
  <div>
    <b-card no-body v-for="(spacetime, index) in spacetime_objs">
      <b-card-header header-tag="header" class="p-1" role="tab">
        Record [[ (index + 1) ]]</b-button>
      </b-card-header>
      <b-card-body>
        <spacetime-obj
          :key="'space-time-obj' + spacetime.uuid"
          v-bind:spacetime="spacetime"
        >
        </spacetime-obj>
      </b-card-body>
    </b-card>
  </div>
</template>


<script type="text/javascript">

  // Import Vue2Leaflet components. 
  const l_popup = Vue.component('l-popup', window.Vue2Leaflet.LPopup);
  const l_tile_layer = Vue.component(
    'l-tile-layer', 
    window.Vue2Leaflet.LTileLayer,
  );
  const l_geo_json = Vue.component(
    'l-geo-json', 
    window.Vue2Leaflet.LGeoJson,
  );
  const l_control_layers = Vue.component(
    'l-control-layers', 
    window.Vue2Leaflet.LControlLayers,
  );
  const l_marker = Vue.component(
    'l-marker', 
    window.Vue2Leaflet.LMarker,
  );
  const l_map = Vue.component(
    'l-map', 
    window.Vue2Leaflet.LMap,
  );
  // Set up some base map tile sources.
  const MAPBOX_PUBLIC_ACCESS_TOKEN = '{{ MAPBOX_PUBLIC_ACCESS_TOKEN|escapejs }}';
  const TILE_PROVIDERS = [
    {
      name: 'OpenStreetMap',
      visible: true,
      id: 'osm',
      url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      attribution: '© <a target="_blank" href="http://osm.org/copyright">OpenStreetMap</a> contributors',
    },
    {
      name: 'OpenTopoMap',
      visible: false,
      id: 'otm',
      url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
      attribution: 'Map data: © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: © <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',
    },
    {
      name: 'MapBox Light',
      visible: false,
      id: 'mapbox-light',
      url: (
        'https://api.mapbox.com/styles/v1/mapbox/light-v10/tiles/{z}/{x}/{y}?access_token=' 
        + MAPBOX_PUBLIC_ACCESS_TOKEN
      ),
      attribution: 'Map data: © <a href="https://MapBox.com">MapBox.com</a>',
    },
    {
      name: 'MapBox Dark',
      visible: false,
      id: 'mapbox-dark',
      url: (
        'https://api.mapbox.com/styles/v1/mapbox/dark-v10/tiles/{z}/{x}/{y}?access_token='
        + MAPBOX_PUBLIC_ACCESS_TOKEN
      ),
      attribution: 'Map data: © <a href="https://MapBox.com">MapBox.com</a>',
    },
    {
      name: 'MapBox Satellite',
      visible: false,
      id: 'mapbox-satellite',
      url: (
        'https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token='
        + MAPBOX_PUBLIC_ACCESS_TOKEN
      ),
      attribution: 'Map data: © <a href="https://MapBox.com">MapBox.com</a>',
    }
  ];


  // Now make a Vue component of for a leaflet map.
  var vc_map = Vue.component(
    'act-map', 
    {
      props: ['spacetime', 'map_key'],
      data() {
        return {
            // Map Options
            map_key: 0,
            zoom_def: 13,
            layers: [],
            selectedTileSet: TILE_PROVIDERS[0], 
            tileProviders: TILE_PROVIDERS,
            minZoom_def: 1,
            maxZoom_def: 30,
            show_mapsets_default: true,
            map_ref: ('map-' + this.spacetime.uuid)
        };
      },
      template: '#act-map',
      created() {
        this.get_map_ref();
      },
      mounted() {
        this.get_map_ref();
      },
      computed: {
        options() {
          return {
            onEachFeature: this.onEachFeatureFunction
          };
        },
        onEachFeatureFunction() {
          return (feature, layer) => {
            layer.bindPopup(
              `<dl class="row">
                <dt class="col-sm-4">Item</dt>
                <dd class="col-sm-8">${this.spacetime.item__label}</dd>
                <dt class="col-sm-4">Record</dt>
                <dd class="col-sm-8">${this.spacetime.event__label}</dd>
                <dt class="col-sm-4">Type</dt>
                <dd class="col-sm-8">${this.spacetime.event__item_class__label}</dd>
                <dt class="col-sm-4">Geometry</dt>
                <dd class="col-sm-8">${this.spacetime.geometry_type}</dd>
              </dl>`
            );
            layer.bindTooltip(
              ("<div>" + feature.properties.item__label + "</div>"),
              { permanent: false, sticky: true }
            );
          };
        },
      },
      methods: {
        get_map_ref: function() {
          console.log(this.$refs);
          console.log(this.$refs[this.map_ref]);
        },
      },
      components: {
        'l-popup': l_popup,
        'l-tile-layer': l_tile_layer,
        'l-geo-json': l_geo_json,
        'l-marker': l_marker,
        'l-map': l_map,
      },
  });


  var vc_spacetime_form = Vue.component(
    'spacetime-form',
    {
      delimiters: ['[[', ']]'],
      props: ['spacetime', 'original_spacetime', 'add_new'],
      data() {
        return {
          spacetime: null,
          original_spacetime: null,
          add_new: false,
          is_value_changed: false,
          updating: false,
          input_start: null,
          input_stop: null,
        }
      },
      template: '#spacetime-form',
      created() {
        this.set_original_spacetime();
      },
      computed: {
        
      },
      methods: {
        set_original_spacetime: function (){
          if(!this.add_new && !this.original_spacetime){
            this.original_spacetime = {};
            for (let key in this.spacetime) {
              if (this.spacetime.hasOwnProperty(key)){
                this.original_spacetime[key] = this.spacetime[key];
              }
            }
          }
        },
        check_value_change: function() {
          if(this.add_new){
            this.is_value_changed = true;
          }
          if(!this.spacetime){
            this.is_value_changed = false;
          }
          if(!this.original_spacetime){
            this.is_value_changed = false;
          }
          this.is_value_changed = false;
          for (let key in this.original_spacetime) {
            if (this.original_spacetime.hasOwnProperty(key)
             && this.spacetime.hasOwnProperty(key)) {
              if(this.original_spacetime[key] != this.spacetime[key]){
                this.is_value_changed = true;
              }
            }
          }
          console.log(this.is_value_changed);
          return this.is_value_changed;
        },
        value_change(input_value) {
          if(this.spacetime.earliest > this.spacetime.latest){
            let temp = this.spacetime.earliest;
            this.spacetime.earliest = this.spacetime.latest;
            this.spacetime.latest = temp;
          }
          this.spacetime.geometry = JSON.parse(this.spacetime.geometry);
          this.$emit('edit_spacetime',this.spacetime);
          this.check_value_change();
        },
        update_spacetime: function (){
          this.error = null;
          this.loading = true;
        },
        add_spacetime: function (){
          this.error = null;
          this.loading = true;
        },
      },
      components: {
        'root-item-tree': vs_root_item_tree,
        'lookup-list': vs_look_up_list,
      },
    }
  ); 


  var vc_spacetime_obj = Vue.component(
    'spacetime-obj',
    {
      delimiters: ['[[', ']]'],
      props: ['spacetime',],
      data() {
        return {
          spacetime: null,
          original_spacetime: null,
          map_key: 1,
        }
      },
      template: '#spacetime-obj',
      created() {
        this.compute_feature();
      },
      computed: {
        
      },
      methods: {
        set_original_spacetime: function (){
          if(!this.add_new && !this.original_spacetime){
            this.original_spacetime = {};
            for (let key in this.spacetime) {
              if (this.spacetime.hasOwnProperty(key)){
                this.original_spacetime[key] = this.spacetime[key];
              }
            }
          }
        },
        compute_feature: function (){
          if(!this.spacetime){
            return null;
          }
          if(!this.spacetime.geometry){
            return null;
          }
          this.spacetime.map_config = {
            center: [
              this.spacetime.latitude,
              this.spacetime.longitude,
            ],
            zoom: 13,
          };
          this.spacetime.feature = {
            type: "Feature",
            geometry: this.spacetime.geometry,
            properties: {
              'item__label': this.spacetime.item__label,
              'event__label': this.spacetime.event__label,
              'event__item_class__label': this.spacetime.event__item_class__label,
            },
          };
        },
        edit_spacetime(spacetime){
          this.spacetime = spacetime;
          this.compute_feature();
          this.map_key += 1;
          console.log(this.spacetime);
        },
        delete_spacetime: function (){
          this.error = null;
          this.loading = true;
        },
      },
      components: {
        'spacetime-form': vc_spacetime_form,
        'act-map': vc_map,
      },
    }
  ); 


  var vc_edit_spacetime = Vue.component(
    'edit-spacetime',
    {
      delimiters: ['[[', ']]'],
      props: ['uuid'],
      data() {
        return {
          uuid: null,
          man_obj: null,
          spacetime_objs: null,
        }
      },
      template: '#edit-spacetime',
      created() {
        this.fetch_api_spacetime();
      },
      methods: {
        fetch_api_spacetime: function (){
          this.error = null;
          this.loading = true;
          fetch(
            ('/editorial/item-spacetimes/' + this.uuid),
              {
                headers:{
                    'Accept': 'application/json',
                }
              }
          )
          .then(this.loading = false)
          .then(response => response.json())
          .then(json => {
            this.spacetime_objs = json;
            console.log(this.spacetime_objs);
          });
        },
      },
      components: {
        'spacetime-obj': vc_spacetime_obj,
      },
    }
  ); 
  
  </script>