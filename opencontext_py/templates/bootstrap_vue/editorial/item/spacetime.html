{% load humanize %}

<!-- 
NOTE: Templates and view components to edit an item's manifest object.
-->

<style>
 .spacetime_row {
   margin-top: 24px;
   margin-bottom: 24px;
 }
</style>

<template id='act-map'>
  <div v-if="spacetime.feature">          
    <l-map
      style="min-height: 300px;"
      :ref="'map' + spacetime.uuid" 
      :zoom="spacetime.map_config.zoom"
      :center="spacetime.map_config.center"
      :load-tiles-while-animating="true" 
      :load-tiles-while-interacting="true">
      <l-control-layers position="topright"></l-control-layers>
      <l-tile-layer
        v-for="tp in tileProviders"
        :key="tp.name"
        :name="tp.name"
        :visible="tp.visible"
        :url="tp.url"
        :attribution="tp.attribution"
        layer-type="base"></l-tile-layer>
      <l-geo-json
      :options="options"
        :geojson="spacetime.feature"
      >
        </l-popup>
      </l-geo-json>
    </l-map>
  </div>
</template>


<template id="spacetime-obj">
  <b-row class="spacetime_row" v-if="spacetime">

    <b-col cols="1">
      <b-button
        sm
        @click="delete_spacetime"
        variant="dark"
        title="Delete location / chronology record"
        class="text-center"><small>Delete <b-icon-x-circle></b-icon-x-circle></small>
      </b-button>
    </b-col>

    <b-col cols="5">

      <b-row>
        <b-col>
          <label :for="'earliest-' + spacetime.uuid">Early Date</label>
          <b-form-input
            v-model="spacetime.earliest"
            :id="'earliest-' + spacetime.uuid"
            type="number"
            @change="value_change"
            :value="spacetime.earliest"
          ></b-form-input>
        </b-col>
      </b-row>

      <b-row>
        <b-col>
          <label :for="'latest-' + spacetime.uuid">Late Date</label>
          <b-form-input
            v-model="spacetime.latest"
            :id="'latest-' + spacetime.uuid"
            type="number"
            @change="value_change"
            :value="spacetime.latest"
          ></b-form-input>
        </b-col>
      </b-row>

      <b-row>
        <b-col>
          <label :for="'lat-' + spacetime.uuid">Latitude</label>
          <b-form-input
            v-model="spacetime.latitude"
            :id="'lat-' + spacetime.uuid"
            type="number"
            @change="value_change"
            :value="spacetime.latitude"
          ></b-form-input>
        </b-col>
      </b-row>

      <b-row>
        <b-col>
          <label :for="'lon-' + spacetime.uuid">Longitude</label>
          <b-form-input
            v-model="spacetime.longitude"
            :id="'lon-' + spacetime.uuid"
            type="number"
            @change="value_change"
            :value="spacetime.longitude"
          ></b-form-input>
        </b-col>
      </b-row>

      <b-row>
        <b-col>
          <label :for="'geometry-' + spacetime.uuid">Geometry</label>
          <b-form-textarea
            :id="'geometry-' + spacetime.uuid"
            debounce="250"
            @change="value_change"
            v-model="spacetime.geometry"
            :value="spacetime.geometry"
          ></b-form-textarea>
        </b-col>
      </b-row>

      <b-row>

        <b-col>
          <b-spinner v-if="updating" label="Updating..."></b-spinner>
          <b-button
            v-if="is_value_changed && !updating"
            sm
            block
            @click="update_spacetime"
            class="text-center"
            variant="info">Update <b-icon-cloud-check-fill></b-icon-cloud-check-fill>
          </b-button>
        </b-col>

      </b-row>


    </b-col>

    <b-col cols="6">
      <act-map v-bind:spacetime="spacetime"></act-map>
    </b-col>

  </b-row>
</template>


<template id="edit-spacetime">
  <div>
    <div v-for="(spacetime, index) in spacetime_objs">
      <spacetime-obj
        :key="'space-time-obj' + spacetime.uuid"
        v-bind:spacetime="spacetime"
      >
      </spacetime-obj>
    </div>
  </div>
</template>


<script type="text/javascript">

  // Import Vue2Leaflet components. 
  const l_popup = Vue.component('l-popup', window.Vue2Leaflet.LPopup);
  const l_tile_layer = Vue.component(
    'l-tile-layer', 
    window.Vue2Leaflet.LTileLayer,
  );
  const l_geo_json = Vue.component(
    'l-geo-json', 
    window.Vue2Leaflet.LGeoJson,
  );
  const l_control_layers = Vue.component(
    'l-control-layers', 
    window.Vue2Leaflet.LControlLayers,
  );
  const l_marker = Vue.component(
    'l-marker', 
    window.Vue2Leaflet.LMarker,
  );
  const l_map = Vue.component(
    'l-map', 
    window.Vue2Leaflet.LMap,
  );
  // Set up some base map tile sources.
  const map_box_token = "pk.eyJ1IjoiZWthbnNhIiwiYSI6IlZFQ1RfM3MifQ.KebFObTZOeh9pDHM_yXY4g";
  const TILE_PROVIDERS = [
      {
            name: 'OpenStreetMap',
            visible: true,
            id: 'osm',
            url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            attribution: '© <a target="_blank" href="http://osm.org/copyright">OpenStreetMap</a> contributors',
      },
      {
            name: 'OpenTopoMap',
            visible: false,
            id: 'otm',
            url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
            attribution: 'Map data: © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: © <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',
      },
      {
            name: 'MapBox Light',
            visible: false,
            id: 'mapbox-light',
            url: ('https://api.tiles.mapbox.com/v4/mapbox.light/{z}/{x}/{y}.png?access_token=' + map_box_token),
            attribution: 'Map data: © <a href="https://MapBox.com">MapBox.com</a>',
      },
      {
            name: 'MapBox Dark',
            visible: false,
            id: 'mapbox-dark',
            url: ('https://api.tiles.mapbox.com/v4/mapbox.dark/{z}/{x}/{y}.png?access_token=' + map_box_token),
            attribution: 'Map data: © <a href="https://MapBox.com">MapBox.com</a>',
      }
  ];


  // Now make a Vue component of for a leaflet map.
  var vc_map = Vue.component(
    'act-map', 
    {
      props: ['spacetime'],
      data() {
        return {
            // Map Options
            zoom_def: 13,
            layers: [],
            selectedTileSet: TILE_PROVIDERS[0], 
            tileProviders: TILE_PROVIDERS,
            minZoom_def: 1,
            maxZoom_def: 30,
            show_mapsets_default: true,
        };
      },
      template: '#act-map',
      computed: {
        options() {
          return {
            onEachFeature: this.onEachFeatureFunction
          };
        },
        onEachFeatureFunction() {
          return (feature, layer) => {
              layer.bindPopup(
                `<dl class="row">
                  <dt class="col-sm-4">Item</dt>
                  <dd class="col-sm-8">${this.spacetime.item__label}</dd>
                  <dt class="col-sm-4">Record</dt>
                  <dd class="col-sm-8">${this.spacetime.event__label}</dd>
                  <dt class="col-sm-4">Type</dt>
                  <dd class="col-sm-8">${this.spacetime.event__item_class__label}</dd>
                  <dt class="col-sm-4">Geometry</dt>
                  <dd class="col-sm-8">${this.spacetime.geometry_type}</dd>
                </dl>`
              );
              layer.bindTooltip(
                ("<div>" + feature.properties.item__label + "</div>"),
                { permanent: false, sticky: true }
              );
              console.log(feature);
          };
        },
      },
      methods: {
        
      },
      components: {
        'l-popup': l_popup,
        'l-tile-layer': l_tile_layer,
        'l-geo-json': l_geo_json,
        'l-marker': l_marker,
        'l-map': l_map,
      },
  });


  var vc_spacetime_obj = Vue.component(
    'spacetime-obj',
    {
      delimiters: ['[[', ']]'],
      props: ['spacetime', 'original_spacetime'],
      data() {
        return {
          spacetime: null,
          original_spacetime: null,
          is_value_changed: false,
          updating: false,
          input_start: null,
          input_stop: null,
        }
      },
      template: '#spacetime-obj',
      created() {
        this.set_original_spacetime();
      },
      computed: {
        
      },
      methods: {
        set_original_spacetime: function (){
          if(!this.original_spacetime){
            this.original_spacetime = {};
            for (let key in this.spacetime) {
              if (this.spacetime.hasOwnProperty(key)){
                this.original_spacetime[key] = this.spacetime[key];
              }
            }
          }
        },
        check_value_change: function() {
          if(!this.spacetime){
            this.is_value_changed = false;
          }
          if(!this.original_spacetime){
            this.is_value_changed = false;
          }
          this.is_value_changed = false;
          for (let key in this.original_spacetime) {
            if (this.original_spacetime.hasOwnProperty(key)
             && this.spacetime.hasOwnProperty(key)) {
              if(this.original_spacetime[key] != this.spacetime[key]){
                this.is_value_changed = true;
              }
            }
          }
          console.log(this.is_value_changed);
          return this.is_value_changed;
        },
        value_change(input_value) {
          if(this.spacetime.earliest > this.spacetime.latest){
            let temp = this.spacetime.earliest;
            this.spacetime.earliest = this.spacetime.latest;
            this.spacetime.latest = temp;
          }
          this.check_value_change();
        },
        delete_spacetime: function (){
          this.error = null;
          this.loading = true;
        },
        update_spacetime: function (){
          this.error = null;
          this.loading = true;
        },
      },
      components: {
        'root-item-tree': vs_root_item_tree,
        'lookup-list': vs_look_up_list,
        'act-map': vc_map,
      },
    }
  ); 


  var vc_edit_spacetime = Vue.component(
    'edit-spacetime',
    {
      delimiters: ['[[', ']]'],
      props: ['uuid'],
      data() {
        return {
          uuid: null,
          man_obj: null,
          spacetime_objs: null,
        }
      },
      template: '#edit-spacetime',
      created() {
        this.fetch_api_spacetime();
      },
      methods: {
        fetch_api_spacetime: function (){
          this.error = null;
          this.loading = true;
          fetch(
            ('/editorial/item-spacetimes/' + this.uuid),
              {
                headers:{
                    'Accept': 'application/json',
                }
              }
          )
          .then(this.loading = false)
          .then(response => response.json())
          .then(json => {
            this.spacetime_objs = [];
            for(let spacetime of json){
              if(spacetime.geometry){
                spacetime.map_config = {
                  center: [
                    spacetime.latitude,
                    spacetime.longitude,
                  ],
                  zoom: 13,
                };
                spacetime.feature = {
                  type: "Feature",
                  geometry: spacetime.geometry,
                  properties: {
                    'item__label': spacetime.item__label,
                    'event__label': spacetime.event__label,
                    'event__item_class__label': spacetime.event__item_class__label,
                  },
                };
              }
              this.spacetime_objs.push(spacetime);
            }
            console.log(this.spacetime_objs);
          });
        },
      },
      components: {
        'spacetime-obj': vc_spacetime_obj,
      },
    }
  ); 
  
  </script>