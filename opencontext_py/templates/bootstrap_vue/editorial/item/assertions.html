{% load humanize %}

<!--
NOTE: Templates and view components to edit assertions made on an item
-->

<style>
 .obj_button {
   margin-top: 6px;
 }
 .obj_edit_exit_button {
  padding-left: 6px;
  padding-right: 6px;
  min-width: 38px;
 }
 .obs_row {
   margin-top: 48px;
 }
 .obj_row {
   margin-top: 12px;
   margin-bottom: 12px;
 }
 .add_obj_row {
   margin-bottom: 24px;
 }
 .pred_col {
   width: 33%;
 }
</style>

<template id="assert-object-edit">
  <div v-if="assert">
    <b-form-group label="Boolean (True/False)" v-if="assert.predicate__data_type == 'xsd:boolean'">
      <b-form-radio :selected="assert.obj_boolean" v-model="selected" :name="'radio-' + assert.uuid" value="true">True</b-form-radio>
      <b-form-radio :selected="assert.obj_boolean" v-model="selected" :name="'radio-' + assert.uuid" value="false">False</b-form-radio>
    </b-form-group>
    <b-form-textarea
      v-if="assert.predicate__data_type == 'xsd:string'"
      debounce="250"
      @change="html_validate"
      :state="is_valid_html"
      :placeholder="assert.obj_string"
      :value="assert.obj_string"
    ></b-form-textarea>
    <b-form-input
      v-if="assert.predicate__data_type == 'xsd:integer'"
      type="number"
      @change="value_change"
      :placeholder="assert.obj_integer"
      :value="assert.obj_integer"
    ></b-form-input>
    <b-form-input
      v-if="assert.predicate__data_type == 'xsd:double'"
      type="number"
      @change="value_change"
      :placeholder="assert.obj_double"
      :value="assert.obj_double"
    ></b-form-input>
    <b-form-input
      v-if="assert.predicate__data_type == 'xsd:date'"
      type="date"
      @change="value_change"
      :value="assert.obj_datetime"
    ></b-form-input>
    <div v-if="assert.predicate__data_type == 'id'">
      <b-row v-if="!for_add_new">
        <b-col cols="2" class="text-center">
          <b-button
            v-if="!is_object_edit_open"
            sm
            block
            @click="toggle_object_edit"
            class="text-center obj_button obj_edit_exit_button"
            variant="info"><small>Edit</small></b-button>
            <b-button
            v-if="is_object_edit_open"
            sm
            block
            class="text-center obj_button obj_edit_exit_button"
            @click="toggle_object_edit"
            variant="outline-secondary"><small>Exit</small></b-button>
        </b-col>
        <b-col cols="10">
          [[assert.object__label]]
          <br/>
          <dl class="row" v-if="!linked_data">
            <dt class="col-sm-2 small">ID: </dt>
            <dt class="col-sm-10 text-muted small">[[assert.object_id]]</dt>
          </dl>
          <dl class="row" v-if="linked_data">
            <dt class="col-sm-2 small">URI:</dt>
            <dd class="col-sm-10 small">
              <a v-if="assert.object__uri"
              :href="'https://' + assert.object__uri"
              target="_blank">https://[[assert.object__uri]] <b-icon-info-circle-fill></b-icon-info-circle-fill>
              </a>
            </dd>
            <dt class="col-sm-2 small">Context:</dt>
            <dd class="col-sm-10 small">[[ assert.object__context__label ]]
              <a v-if="assert.object__context__uri" :href="'https://' + assert.object__context__uri" target="_blank"><b-icon-info-circle-fill></b-icon-info-circle-fill></a>
            </dd>
          </dl>
        </b-col>
      </b-row>
      <b-row v-if="for_add_new || is_object_edit_open">
        <b-col v-if="!linked_data && assert.predicate__item_class_id == OC_VARIABLES.uuid">
          <lookup-list
            :key="'lookup' + assert.uuid"
            v-bind:context_id="[assert.predicate_id]"
            v-bind:show_label_search_box="true"
            v-bind:fetch_on_create="true"
            @set_selected_item="set_selected_obj_item($event)"
          ></lookup-list>
        </b-col>
        <b-col v-if="!linked_data && assert.predicate__item_class_id == OC_LINKS.uuid">
          <lookup-list
            :key="'lookup' + assert.uuid"
            v-bind:project_id="ITEM_PROJECT_UUIDS"
            v-bind:item_type="OC_PRED_LINK_OK_ITEM_TYPES"
            v-bind:show_id_search_box="true"
            v-bind:show_label_search_box="true"
            @set_selected_item="set_selected_obj_item($event)"
          ></lookup-list>
        </b-col>

        <b-col v-if="linked_data">
          <div v-if="ITEM_TYPE=='types'">

            <lookup-list
              :key="'lookup' + assert.uuid"
              v-bind:item_type="['types', 'class', 'property', 'units', 'uri', 'persons', 'tables', 'projects',]"
              v-bind:show_id_search_box="true"
              v-bind:show_label_search_box="true"
              v-bind:show_context="true"
              v-bind:do_meta="true"
              v-bind:show_total_results="true"
              @set_selected_item="set_selected_obj_item($event)"
            ></lookup-list>

          </div>
          <div v-else>

            <lookup-list
              :key="'lookup' + assert.uuid"
              v-bind:item_type="['class', 'property', 'units', 'uri', 'persons', 'tables', 'projects',]"
              v-bind:show_id_search_box="true"
              v-bind:show_label_search_box="true"
              v-bind:show_context="true"
              v-bind:do_meta="true"
              v-bind:show_total_results="true"
              @set_selected_item="set_selected_obj_item($event)"
            ></lookup-list>
          </div>

        </b-col>
      </b-row>
    </div>
  </div>
</template>


<template id="assert-uuid">
  <b-row>
    <b-col>
      <div v-for="(alert_uuid, index) in alert_update_uuids">
        <b-alert
          v-if="alert_uuid == assert.uuid"
          class="row_update_alert"
          :show="dismissCountDown"
          responsive="sm"
          fade
          variant="success"
          @dismissed="onDissmiss"
          @dismiss-count-down="countDownChanged"
          ><b-icon-cloud-upload-fill></b-icon-cloud-upload-fill>
        </b-alert>
        <span v-else>[[assert.updated]]</span>
      </div>
    </b-col>
  </b-row>
</template>


<template id='assert-object'>
  <b-row class="obj_row">

    <b-col cols="1" class="text-center">
      <b-button
        sm
        @click="open_delete_confirm"
        variant="secondary"
        title="Delete assertion"
        class="text-center obj_button"><small><b-icon-x-circle></b-icon-x-circle></small>
      </b-button>

      <b-overlay no-wrap z-index="100" :show="show_delete_confirm" @hidden="on_delete_confirm_hide">
        <template #overlay>
          <b-spinner v-if="updating" label="Deleting..."></b-spinner>
          <b-card
            v-else
            ref="dialog"
            bg-variant="light"
            z-index="100"
            role="dialog"
            aria-modal="false"
            variant="white" opacity="0.90"
            :aria-labelledby="'delete-confirm-label-' + assert.uuid"
            class="text-center p-3"
          >
            <p>
              <strong :id="'delete-confirm-label-' + assert.uuid">Confirm deletion</strong>
            </p>
            <div class="d-flex">
              <b-button variant="outline-danger" class="mr-3" @click="on_delete_confirm_hide">
                Cancel
              </b-button>
              <b-button variant="outline-success" @click="delete_assertion">OK</b-button>
            </div>
          </b-card>
        </template>
      </b-overlay>


    </b-col>

    <b-col cols="7">

      <assert-object-edit
        v-bind:assert="assert"
        v-bind:linked_data="linked_data"
        @get_validation_errors="get_validation_errors($event)"
        @get_value_change="get_value_change($event)"
      >
      </assert-object-edit>

    </b-col>
    <b-col cols="1">
      <div v-if="show_sort_placement">
        <b-button
          sm
          @click="move_up"
          variant="secondary"
          title="Delete assertion"
          class="text-center obj_button"><small><b-icon-arrow-up-square></b-icon-arrow-up-square></small>
        </b-button>
        <b-button
          sm
          @click="move_down"
          variant="secondary"
          title="Delete assertion"
          class="text-center obj_button"><small><b-icon-arrow-down-square></b-icon-arrow-down-square></small>
        </b-button>
      </div>
    </b-col>
    <b-col cols="3" class="text-center">
      <b-spinner v-if="updating" label="Updating..."></b-spinner>
      <b-button
        v-if="is_value_changed && !updating"
        sm
        block
        @click="update_object_value"
        class="text-center"
        variant="info">Update to <strong>[[ disp_changed_value ]]</strong>
        <b-icon-cloud-check-fill></b-icon-cloud-check-fill>
      </b-button>
      <b-list-group v-if="errors">
        <b-list-group-item v-for="(error, index) in errors"
        :key="assert.uuid + '-error-' + index"
        variant="warning">
        <small>[[error]]</small>
        </b-list-group-item>
      </b-list-group>
    </b-col>
  </b-row>
</template>


<template id='assert-objects'>
  <div>
    <assert-object
      v-for="(assert, index) in assert_node.objs"
      :key="assert.uuid"
      @assertion_update_done="assertion_update_done($event)"
      v-bind:assert="assert"
      v-bind:show_sort_placement="(assert_node.objs.length > 1)"
      v-bind:linked_data="linked_data"
    ></assert-object>
  </div>
</template>


<template id='add-assertion-ui'>
  <b-modal
    size="lg"
    scrollable
    ref="add-assertion-modal"
    id="add-assertion-modal"
    :title="'Add Attribute or Relationship to: ' + act_obs.label"
    @shown="on_shown"
  >
    <b-container fluid>

      <b-alert  v-if="selected_pred_item && new_object_display" show variant="success">
        <b-row>
          <b-col cols="4">
            <small>Attribute/Relationship Predicate</small><br/>
            [[ selected_pred_item.label ]]
          </b-col>
          <b-col cols="2" class="text-center"><b-icon-arrow-right></b-icon-arrow-right></b-col>
          <b-col cols="4">
            <small>Attribute/Relationship Object Value</small><br/>
            [[ new_object_display ]]
          </b-col>
          <b-col cols="2">
            <b-spinner v-if="updating" label="Updating..."></b-spinner>
            <b-button
              v-if="!updating"
              @click="add_assertion"
            >
              Add <b-icon-cloud-arrow-up-fill></b-icon-cloud-arrow-up-fill>
            </b-button>
          </b-col>
        </b-row>
      </b-alert>

      <b-alert v-else show variant="info">
        <b-row>
          <b-col cols="4">
            <div v-if="selected_pred_item">
              <small>Attribute/Relationship Predicate</small><br/>
              [[ selected_pred_item.label ]]
            </div>
            <small v-else class="text-muted">Select Attribute/Relationship Predicate</small>
          </b-col>
          <b-col cols="2">&nbsp;</b-col>
          <b-col cols="4">&nbsp;</b-col>
          <b-col cols="2">
            <b-button
              disabled="true"
              @click="add_assertion"
            >
              Add <b-icon-cloud-arrow-up-fill></b-icon-cloud-arrow-up-fill>
            </b-button>
          </b-col>
        </b-row>
      </b-alert>

      <b-row>
        <b-col cols="5">
          <lookup-list
            v-if="!linked_data"
            :key="'lookup' + act_obs.id"
            v-bind:project_id="ITEM_PROJECT_UUIDS"
            v-bind:item_type="['predicates']"
            v-bind:show_label_search_box="true"
            @set_selected_item="set_selected_pred_item($event)"
          ></lookup-list>
          <lookup-list
            v-if="linked_data"
            :key="'lookup' + act_obs.id"
            v-bind:show_label_search_box="true"
            v-bind:show_context="true"
            v-bind:do_meta="true"
            v-bind:show_total_results="true"
            v-bind:item_type="['property']"
            v-bind:show_label_search_box="true"
            @set_selected_item="set_selected_pred_item($event)"
          ></lookup-list>
          <small class="text-muted">Look up a descriptive attribute or linking relationship to add</small>
        </b-col>
        <b-col cols="1"></b-col>
        <b-col cols="4">

            <assert-object-edit
              v-bind:assert="assert"
              v-bind:for_add_new="true"
              v-bind:linked_data="linked_data"
              @get_validation_errors="get_validation_errors($event)"
              @get_value_change="get_value_change($event)"
            >
            </assert-object-edit>

            <small class="text-muted">Add Attribute or Relationship Object Value</small>
          </div>
        </b-col>
        <b-col cols="2">
          <b-list-group v-if="errors">
            <b-list-group-item v-for="(error, index) in errors"
            :key="act_obs.id + '-error-' + index"
            variant="warning">
            <small>[[error]]</small>
            </b-list-group-item>
          </b-list-group>
        </b-col>
      </b-row>
    </b-container>

    <template #modal-footer="{ ok, cancel, hide }">
      <b-button size="sm" variant="secondary" @click="cancel()">
        Close
      </b-button>
    </template>
  </b-modal>

</template>

<template id="edit-observation">
  <div>
    <b-table
      v-if="act_obs.assertions"
      ref="obs_assertions"
      small
      striped
      table-variant="secondary"
      :select-mode="selectMode"
      :items="act_obs.assertions"
      :fields="fields"
      @row-selected="onRowSelected"
      :sort-by.sync="sortBy"
      :sort-desc.sync="sortDesc"
      responsive="lg"
      caption-top
    >
      <template #table-caption>[[ act_obs.label ]]</template>

      <template #cell(uuid)="data">
        <assert-uuid
          @countdown_done="remove_alert_update_uuid($event)"
          v-bind:alert_timer_state="alert_timer_state"
          v-bind:alert_timer_duration="alert_timer_duration"
          v-bind:assert="data.item"
          v-bind:alert_update_uuids="alert_update_uuids">
        </assert-uuid>
      </template>

      <template #cell(predicate__label)="data">
        <p v-if="data.item.event_id != DEFAULT_EVENT.uuid">
          <small>[[ data.item.event__label ]]</small>
        </p>
        <p v-if="data.item.attribute_group_id != DEFAULT_ATTRIBUTE_GROUP.uuid">
          <small>[[ data.item.attribute_group__label ]]</small>
        </p>
        [[ data.item.predicate__label ]]
        <dl class="row" v-if="linked_data">
          <dt class="col-sm-2 small">URI:</dt>
          <dd class="col-sm-10 small">
            <a v-if="data.item.predicate__context__uri"
            :href="'https://' + data.item.predicate__uri"
            target="_blank">https://[[data.item.predicate__uri]] <b-icon-info-circle-fill></b-icon-info-circle-fill>
            </a>
          </dd>
          <dt class="col-sm-2 small">Context:</dt>
          <dd class="col-sm-10 small">[[ data.item.predicate__context__label ]]
            <a v-if="data.item.predicate__context__uri" :href="'https://' + data.item.predicate__context__uri" target="_blank"><b-icon-info-circle-fill></b-icon-info-circle-fill></a>
          </dd>
        </dl>
      </template>

      <template #cell(objs)="data">
        <assert-objects
          @assertion_update_done="assertion_update_done($event)"
          v-bind:assert_node="data.item"
          v-bind:linked_data="linked_data"
        >
        </assert-objects>
      </template>

      <template #cell()="data">
        [[ data.value ]]
      </template>

    </b-table>

    <b-row>
      <b-col cols="2">
        <b-button
          sm
          block
          @click="toggle_add_new_assertion"
          variant="primary">Add New <b-icon-plus-circle-fill></b-icon-plus-circle-fill></b-button>
      </b-col>
      <b-col cols="10">Add another Attribute or Relationship to [[ act_obs.label ]]</b-col>
    </b-row>

    <add-assertion-ui
      v-bind:act_obs="act_obs"
      v-bind:linked_data="linked_data"
      @assertion_update_done="assertion_update_done($event)"
    >
    </add-assertion-ui>

  </div>
</template>


<template id="edit-assertions">
  <div v-if="assertions_in_obs">
    <h4 v-if="!linked_data">Observation Count [[ assertions_in_obs.length ]]</h4>
    <b-row class="obs_row" v-for="(act_obs, index) in assertions_in_obs">
      <b-col>
        <edit-observation
          @assertion_update_done="assertion_update_done($event)"
          v-bind:act_obs="act_obs"
          v-bind:linked_data="linked_data"
          v-bind:table_height="table_height"></edit-observation>
      </b-col>
    </b-row>


  </div>
</template>


<template id="edit-ld-assertions">
  <edit-assertions
    v-bind:uuid="uuid"
    v-bind:table_height="table_height"
    v-bind:linked_data="linked_data"
    @edit_done="edit_done"
  ></edit-assertions>
</template>


<script type="text/javascript">

const DEFAULT_EVENT = JSON.parse('{{ DEFAULT_EVENT|escapejs }}');
const DEFAULT_ATTRIBUTE_GROUP = JSON.parse('{{ DEFAULT_ATTRIBUTE_GROUP|escapejs }}');
const DEFAULT_LANG = JSON.parse('{{ DEFAULT_LANG|escapejs }}');
const PREDICATE_CONTAINS = JSON.parse('{{ PREDICATE_CONTAINS|escapejs }}');
const OC_VARIABLES = JSON.parse('{{ OC_VARIABLES|escapejs }}');
const OC_LINKS = JSON.parse('{{ OC_LINKS|escapejs }}');
const OC_PRED_LINK_OK_ITEM_TYPES = JSON.parse('{{ OC_PRED_LINK_OK_ITEM_TYPES|escapejs }}');

  var vs_assert_uuid = Vue.component(
    'assert-uuid',
    {
      delimiters: ['[[', ']]'],
      props: ['assert', 'alert_update_uuids', 'alert_timer_duration', 'alert_timer_state'],
      data() {
        return {
          assert: null,
          dismissSecs: 2,
          dismissCountDown: 2,
        };
      },
      template: '#assert-uuid',
      methods: {
        countDownChanged(dismissCountDown) {
          this.dismissCountDown = dismissCountDown
        },
        showAlert() {
          this.dismissCountDown = this.dismissSecs
        },
        onDissmiss(){
          this.$emit('countdown_done', this.assert.uuid);
          // Reset the dismiss countdown to re-render if
          // this ds_field gets another update.
          this.dismissCountDown = this.dismissSecs;
        },
      }
    },
  );


  var vs_assert_object_edit = Vue.component(
    'assert-object-edit',
    {
      delimiters: ['[[', ']]'],
      props: ['assert', 'linked_data', 'for_add_new'],
      data() {
        return {
          assert: null,
          linked_data: false,
          for_add_new: false,
          is_object_edit_open: false,
          selected_obj_item: null,
          input_value: null,
          is_valid_html: null,
          errors: null,
          input_value: null,
          is_value_changed: null,
        };
      },
      template: '#assert-object-edit',
      computed: {

      },
      methods: {
        toggle_object_edit() {
          if(this.is_object_edit_open === null){
            this.is_object_edit_open = false;
          }
          this.is_object_edit_open = !this.is_object_edit_open;
        },
        get_original_value() {
          if(!this.assert){
            return null;
          }
          if(this.assert.predicate__data_type == 'xsd:boolean'){
            return assert.obj_boolean;
          }
          if(this.assert.predicate__data_type == 'xsd:string'){
            return this.assert.obj_string;
          }
          if(this.assert.predicate__data_type == 'xsd:integer'){
            return this.assert.obj_integer;
          }
          if(this.assert.predicate__data_type == 'xsd:double'){
            return this.assert.obj_double;
          }
          if(this.assert.predicate__data_type == 'xsd:date'){
            return this.assert.obj_datetime;
          }
          if(this.assert.predicate__data_type == 'id'){
            return this.assert.object_id;
          }
          return null;
        },
        get_display_value(input_value){
          if(input_value === null){
            return null;
          }
          let max_length = 20;
          let act_val = '';
          if(!this.selected_obj_item){
            act_val += input_value;
          }
          else{
            act_val += this.selected_obj_item.label;
          }
          return act_val.length > max_length ? act_val.substring(0, max_length) + "..." : act_val;
        },
        value_change(input_value) {
          this.input_value = input_value;
          let orig_value = this.get_original_value();
          let is_value_changed = (input_value != orig_value);
          let output = {
            input_value: input_value,
            is_value_changed: is_value_changed,
            disp_changed_value: this.get_display_value(input_value),
          };
          this.$emit('get_value_change', output);
          return output;
        },
        set_selected_obj_item(obj_item) {
          this.selected_obj_item = obj_item;
          this.input_value = this.selected_obj_item.uuid;
          this.value_change(this.selected_obj_item.uuid);
          console.log('selected_item: ' + this.selected_obj_item.label);
        },
        html_validate(input_value) {
          this.input_value = input_value.trim();
          this.value_change(input_value);
          const requestOptions = {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify(
              {str: input_value}
            ),
          };
          fetch('/editorial/html-validate', requestOptions)
            .then(async response => {
              const data = await response.json();
              // check for error response
              if (!response.ok) {
                // get error message from body or default to response status
                const error = (data && data.message) || response.status;
                return Promise.reject(error);
              }
              this.is_valid_html = data.ok;
              this.errors = data.errors;
              this.$emit('get_validation_errors', this.errors);
            })
            .catch(error => {
              this.errorMessage = error;
              console.error('There was an error!', error);
            }
          );
        },
      },
      components: {
        'root-item-tree': vs_root_item_tree,
        'lookup-list': vs_look_up_list,
      },
    },
  );


  var vs_assert_object = Vue.component(
    'assert-object',
    {
      delimiters: ['[[', ']]'],
      props: ['assert', 'linked_data', 'show_sort_placement'],
      data() {
        return {
          assert: null,
          linked_data: false,
          is_value_changed: null,
          input_value: null,
          errors: null,
          updating: false,
          show_delete_confirm: false,
          show_sort_placement: false,
        };
      },
      template: '#assert-object',
      computed: {
      },
      methods: {
        get_validation_errors(errors) {
          this.errors = errors;
        },
        get_value_change(changes) {
          console.log(changes);
          this.input_value =  changes.input_value;
          this.is_value_changed = changes.is_value_changed;
          this.disp_changed_value = changes.disp_changed_value;
        },
        open_delete_confirm: function() {
          this.show_delete_confirm = true;
        },
        on_delete_confirm_hide: function () {
          this.show_delete_confirm = false;
        },
        delete_assertion: function() {
          this.show_delete_confirm = false;
          this.updating = true;
          let delete_obj = {
            uuid: this.assert.uuid,
          };
          let delete_objs = [];
          delete_objs.push(delete_obj);
          const requestOptions = {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify(delete_objs)
          };
          fetch('/editorial/item-delete-assertions', requestOptions)
          .then(async response => {
            const data = await response.json();
            // check for error response
            if (!response.ok) {
              // get error message from body or default to response status
              const error = (data && data.message) || response.status;
              return Promise.reject(error);
            }
            // Share the news we just did an edit
            this.input_value = null;
            this.updating = false;
            this.$emit('assertion_update_done', true);
          })
          .catch(error => {
            this.errorMessage = error;
            console.error('There was an error!', error);
          });
        },
        update_object_value: function() {
          if(this.input_value === null){
            console.log('No input value for the object');
            return null;
          }
          if(this.input_value === this.returned_value){
            console.log('No object value change detected');
            return null;
          }
          this.updating = true;
          let update_obj = {
            uuid: this.assert.uuid,
            // subject_id: this.assert.subject_id,
            // observation_id: this.assert.observation_id,
            // event_id: this.assert.event_id,
            // attribute_group_id: this.assert.attribute_group_id,
            // predicate_id: this.assert.predicate_id,
            // language_id: this.assert.language_id,
            // sort: this.assert.sort,
          };
          if(this.assert.predicate__data_type == 'xsd:boolean'){
            update_obj.obj_boolean = this.input_value;
          }
          if(this.assert.predicate__data_type == 'xsd:string'){
            update_obj.obj_string = this.input_value;
          }
          if(this.assert.predicate__data_type == 'xsd:integer'){
            update_obj.obj_integer = this.input_value;
          }
          if(this.assert.predicate__data_type == 'xsd:double'){
            update_obj.obj_double = this.input_value;
          }
          if(this.assert.predicate__data_type == 'xsd:date'){
            update_obj.obj_datetime = this.input_value;
          }
          if(this.assert.predicate__data_type == 'id'){
            update_obj.object_id = this.input_value;
          }
          let update_objs = [];
          update_objs.push(update_obj);
          const requestOptions = {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify(update_objs)
          };
          fetch('/editorial/item-update-assertions', requestOptions)
          .then(async response => {
            const data = await response.json();
            // check for error response
            if (!response.ok) {
              // get error message from body or default to response status
              const error = (data && data.message) || response.status;
              return Promise.reject(error);
            }
            // Share the news we just did an edit
            this.input_value = null;
            this.updating = false;
            this.$emit('assertion_update_done', true);
          })
          .catch(error => {
            this.errorMessage = error;
            console.error('There was an error!', error);
          });
        },
        move_update(move_sort){
          this.updating = true;
          let update_obj = {
            uuid: this.assert.uuid,
            move_sort: move_sort,
          };
          let update_objs = [];
          update_objs.push(update_obj);
          const requestOptions = {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify(update_objs)
          };
          fetch('/editorial/item-update-assertions', requestOptions)
          .then(async response => {
            const data = await response.json();
            // check for error response
            if (!response.ok) {
              // get error message from body or default to response status
              const error = (data && data.message) || response.status;
              return Promise.reject(error);
            }
            // Share the news we just did an edit
            this.input_value = null;
            this.updating = false;
            this.$emit('assertion_update_done', true);
          })
          .catch(error => {
            this.errorMessage = error;
            console.error('There was an error!', error);
          });
        },
        move_up: function(){
          console.log('Move up');
          return this.move_update('up');
        },
        move_down: function(){
          console.log('Move down');
          return this.move_update('down');
        },
      },
      components: {
        'assert-object-edit': vs_assert_object_edit,
      },
    },
  );

  var vs_assert_objects = Vue.component(
    'assert-objects',
    {
      delimiters: ['[[', ']]'],
      props: ['assert_node', 'linked_data',],
      data() {
        return {
          linked_data: false,
          assert: null,
        };
      },
      template: '#assert-objects',
      methods: {
        assertion_update_done(v){
          this.$emit('assertion_update_done', true);
        }
      }
    },
  );

  var vs_add_assertion_ui = Vue.component(
    'add-assertion-ui',
    {
      delimiters: ['[[', ']]'],
      props: ['act_obs', 'linked_data'],
      data() {
        return {
          linked_data: false,
          act_obs: null,
          selected_pred_item: null,
          new_object_display: null,
          new_object_val: null,
          new_object_item: null,
          errors: null,
          updating: false,
        }
      },
      template: '#add-assertion-ui',
      computed: {
        assert: function() {
          if(!this.selected_pred_item){
            return null;
          }
          return {
            uuid: this.selected_pred_item.uuid + '-new-assert',
            predicate_id: this.selected_pred_item.uuid,
            predicate__label: this.selected_pred_item.label,
            predicate__data_type: this.selected_pred_item.data_type,
            predicate__item_class_id: this.selected_pred_item.item_class_id,
            predicate__item_class__label: this.selected_pred_item.item_class__label,
            obj_boolean: null,
            obj_string: null,
            obj_integer: null,
            obj_double: null,
            obj_datetime: null,
            object_id: null,
            object__label: null,
          };
        },
      },
      methods: {
        get_validation_errors(errors) {
          this.errors = errors;
        },
        get_value_change(changes) {
          console.log(changes);
          this.new_object_val =  changes.input_value;
          this.new_object_display = changes.disp_changed_value;
        },
        assertion_update_done(v){
          this.$emit('assertion_update_done', true);
        },
        on_shown: function() {
          this.show_add_assertion_ui = true;
          console.log('on_shown;');
        },
        set_selected_pred_item(pred_item) {
          this.selected_pred_item = pred_item;
          console.log('selected_pred_item: ' + this.selected_pred_item.label);
        },
        add_assertion: function() {
          this.updating = true;
          console.log('add-assertion');
          if(this.new_object_val === null || this.selected_pred_item === null){
            console.log('No input value for the object');
            return null;
          }
          let add_obj = {
            subject_id: ITEM_UUID,
            predicate_id: this.selected_pred_item.uuid,
            // observation_id: this.assert.observation_id,
            // event_id: this.assert.event_id,
            // attribute_group_id: this.assert.attribute_group_id,
            // language_id: this.assert.language_id,
            // sort: this.assert.sort,
          };
          if(this.selected_pred_item.data_type == 'xsd:boolean'){
            add_obj.obj_boolean = this.new_object_val;
          }
          if(this.selected_pred_item.data_type == 'xsd:string'){
            add_obj.obj_string = this.new_object_val;
          }
          if(this.selected_pred_item.data_type == 'xsd:integer'){
            add_obj.obj_integer = this.new_object_val;
          }
          if(this.selected_pred_item.data_type == 'xsd:double'){
            add_obj.obj_double = this.new_object_val;
          }
          if(this.selected_pred_item.data_type == 'xsd:date'){
            add_obj.obj_datetime = this.new_object_val;
          }
          if(this.selected_pred_item.data_type == 'id'){
            add_obj.object_id = this.new_object_val;
          }
          let add_objs = [];
          add_objs.push(add_obj);
          const requestOptions = {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify(add_objs)
          };
          fetch('/editorial/item-add-assertions', requestOptions)
          .then(async response => {
            const data = await response.json();
            // check for error response
            if (!response.ok) {
              // get error message from body or default to response status
              const error = (data && data.message) || response.status;
              return Promise.reject(error);
            }
            // Share the news we just did an edit
            this.input_value = null;
            this.$emit('assertion_update_done', true);
          })
          .catch(error => {
            this.errorMessage = error;
            console.error('There was an error!', error);
          });
        },
      },
      components: {
        'lookup-list': vs_look_up_list,
        'assert-object-edit': vs_assert_object_edit,
      },
    },
  );

  var vc_edit_observation = Vue.component(
    'edit-observation',
    {
      delimiters: ['[[', ']]'],
      props: ['act_obs', 'linked_data', 'table_height'],
      data() {
        return {
          linked_data: false,
          act_obs: null,
          table_height: '900px',
          modes: ['multi', 'single', 'range'],
          sortBy: 'sort',
          sortDesc: false,
          fields: [
            {
              key: 'predicate__label',
              label:'Attribute or Relationship (Predicate)',
              class: 'pred_col',
              sortable: false
            },
            {
              key: 'objs',
              label:'Attribute Values',
              sortable: false
            },
          ],
          items: [],
          selectMode: 'range',
          selected: [],
          alert_update_uuids: [],
          alert_timer_duration: 2, // length of time the alerts stay up.
          alert_timer_state: 0,
        }
      },
      template: '#edit-observation',
      created() {

      },
      computed: {

      },
      methods: {
        add_alert_update_uuid(uuid) {
          const index = this.alert_update_uuids.indexOf(uuid);
          if (index > -1) {
            return null;
          }
          this.alert_update_uuids.push(uuid);
          this.alert_timer_state = this.alert_timer_duration;
        },
        add_alert_update_uuid_list(uuid_list){
          for (let uuid of uuid_list){
            this.add_alert_update_uuid(uuid);
          }
        },
        remove_alert_update_uuid(uuid) {
          const index = this.alert_update_uuids.indexOf(uuid);
          if (index > -1) {
            this.alert_update_uuids.splice(index, 1);
          }
          this.alert_timer_state = 0;
          // Remove all the uuids from the alerts all at once.
          this.alert_update_uuids = [];
        },
        clear_alert_update_uuids(){
          this.alert_update_uuids = [];
        },
        onRowSelected(items) {
          this.selected = items
        },
        selectAllRows() {
          this.$refs.dsFieldsGeneralTable.selectAllRows()
        },
        clearSelected() {
          this.$refs.dsFieldsGeneralTable.clearSelected()
        },
        assertion_update_done(v){
          this.$emit('assertion_update_done', true);
        },
        toggle_add_new_assertion() {
          this.$bvModal.show('add-assertion-modal');
        },
      },
      components: {
        'assert-uuid': vs_assert_uuid,
        'assert-objects': vs_assert_objects,
        'add-assertion-ui': vs_add_assertion_ui,
      },
    }
  );

  var vc_edit_assertions = Vue.component(
    'edit-assertions',
    {
      delimiters: ['[[', ']]'],
      props: ['uuid', 'linked_data', 'table_height'],
      data() {
        return {
          uuid: null,
          linked_data: false,
          table_height: '900px',
          assertions_in_obs: [],
          non_pred_keys: [
            'id',
            'label',
            'type',
            'oc_gen_has_events',
            'oc_gen_has_attribute_groups'
          ],
          emit_edit_done:false,
        }
      },
      template: '#edit-assertions',
      created() {
        this.fetch_api_assertions();
      },
      computed: {

      },
      methods: {
        process_assertions(json) {
          let new_obs = [];
          for(let obs of json){
            let obs_assertions = [];
            let act_events = [];
            if('oc_gen_has_events' in obs){
              for(let event of obs.oc_gen_has_events){
                act_events.push(event);
              }
            }
            else{
              act_events.push(obs);
            }
            let act_attrib_group = [];
            for(let event of act_events){
              if('oc_gen_has_attribute_groups' in event){
                for(let a_group of event.oc-gen_has_attribute_groups){
                  act_attrib_group.push(a_group);
                }
              }
              else{
                act_attrib_group.push(event);
              }
            }
            for(let a_group of act_attrib_group){
              for (let key in a_group) {
                let key_index = this.non_pred_keys.indexOf(key);
                if(key_index >= 0){
                  continue;
                }
                if (a_group.hasOwnProperty(key)) {
                  let obs_assert_node = a_group[key][0];
                  obs_assert_node.objs = a_group[key];
                  obs_assertions.push(obs_assert_node);
                }
              }
            }
            let obs_label = obs.label;
            if(this.linked_data && new_obs.length == 0){
              obs_label = "Standards Aligned, Linked Data";
            }
            let new_obs_item = {
              label: obs_label,
              id: obs.id.replace('#', ''),
              assertions: obs_assertions,
            }
            new_obs.push(new_obs_item);
          }

          if(new_obs.length < 1){
            let obs_label = 'Prepare Item Observation';
            if(this.linked_data){
              obs_label = 'Prepare Standards Aligned, Linked Data';
            }
            let new_obs_item = {
              label: obs_label,
              id: 0,
              assertions: [],
            }
            new_obs.push(new_obs_item);
          }
          return new_obs;
        },
        fetch_api_assertions: function (){
          this.error = null;
          this.loading = true;
          let url = '/editorial/item-assertions/' + this.uuid;
          if(this.linked_data){
            url += '?linked-data=1';
          }
          fetch(
            (url),
            {
              headers:{
                  'Accept': 'application/json',
              }
            },
          )
          .then(this.loading = false)
          .then(response => response.json())
          .then(json => {
            this.assertions_in_obs = this.process_assertions(json);
            console.log(this.assertions_in_obs);
            if(this.emit_edit_done){
              this.emit_edit_done = false;
              this.$emit('edit_done', true);
            }
          })
        },
        assertion_update_done(v){
          this.emit_edit_done = true;
          this.fetch_api_assertions();
        }
      },
      components: {
        'root-item-tree': vs_root_item_tree,
        'lookup-list': vs_look_up_list,
        'edit-observation': vc_edit_observation,
      },
    }
  );

  var vc_edit_ld_assertions = Vue.component(
    'edit-ld-assertions',
    {
      delimiters: ['[[', ']]'],
      props: ['uuid', 'table_height'],
      data() {
        return {
          uuid: null,
          linked_data: true,
          table_height: '900px',
        }
      },
      template: '#edit-ld-assertions',
      methods: {
        edit_done(v){
          this.$emit('edit_done', true);
        },
      },
      components: {
        'edit-assertions': vc_edit_assertions,
      },
    }
  );

</script>