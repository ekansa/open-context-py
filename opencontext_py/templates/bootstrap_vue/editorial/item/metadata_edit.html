{% load humanize %}

<!-- 
NOTE: Templates and view components to edit an item's identifier objects
-->

<style>
.meta_form {
  padding-top: 24px;
  padding-bottom: 24px;
}
.meta_field_row {
   margin-top: 12px;
   margin-bottom: 12px;
}
</style>


<template id="meta-json-form-item">
  <b-row class="meta_field_row">
    <b-col>
      <p><strong>[[ key_config.label ]]</strong> ([[ key_config.key ]])</p>
      <p><small>[[ key_config.note ]]</small></p>
      <b-form-textarea
        v-if="key_config.data_type == 'xsd:string'"
        debounce="250"
        @change="html_validate"
        :state="is_valid_html"
        :placeholder="meta_json[key_config.key]"
        :value="meta_json[key_config.key]"
      ></b-form-textarea>

      <b-form-select
        v-if="key_config.options"
        v-model="meta_json[key_config.key]"
        :options="key_config.options"
        class="mb-3"
      ></b-form-select>

      <b-form-input
        v-if="key_config.data_type == 'xsd:integer' && !key_config.options"
        type="number"
        @change="value_change"
        :placeholder="meta_json[key_config.key]"
        :value="meta_json[key_config.key]"
      ></b-form-input>
    </b-col>
    <b-col>

    </b-col>
  </b-row>
</template>


<template id="meta-json-form">
  <b-container fluid class="meta_form alert-secondary">
    <h5>Administrative Metadata</h5>
    <meta-json-form-item v-for="(key_config, index) in meta_configs"
      v-bind:key_config="key_config"
      v-bind:meta_json="meta_json"
      v-bind:item_id="item_id"
      v-bind:add_new="add_new"
      @get_value_change="get_value_change($event)"
    >
    </meta-json-form-item>
  </div>
</template>





<script type="text/javascript">

var vc_meta_json_form_item = Vue.component(
  'meta-json-form-item',
  {
    delimiters: ['[[', ']]'],
    props: ['meta_json', 'key_config', 'item_id', 'add_new'],
    data() {
      return {
        key_config: null,
        meta_json: null,
        item_id: null,
        add_new: false,
        original_meta_json_str: null,
        is_value_changed: false,
        is_valid_html: null,
        errors: null,
      };
    },
    template: '#meta-json-form-item',
    mounted() {
      this.set_original_meta_json();
    },
    methods: {
      set_original_meta_json: function (){
        if(!this.add_new && this.meta_json){
          // Hack to make a deep-copy.
          this.original_meta_json_str = JSON.stringify(this.meta_json);
          console.log('Original meta_json cached as JSON str');
        }
      },
      reset_to_original_meta_json: function () {
        if(this.original_meta_json_str){
          this.meta_json = JSON.parse(this.original_meta_json_str);
          this.is_value_changed = false;
          console.log('Reset to original meta_json from cache');
        }
      },
      get_original_value() {
        if(this.original_meta_json_str){
          let orig_meta_json = JSON.parse(this.original_meta_json_str);
          return orig_meta_json[this.key_config.key];
        }
        return null;
      },
      value_change(input_value) {
        this.meta_json[this.key_config.key] = input_value;
        let orig_value = this.get_original_value();
        let is_value_changed = (input_value != orig_value);
        let output = {
          input_value: input_value,
          is_value_changed: is_value_changed,
          meta_json: this.meta_json,
        };
        console.log(output);
        this.$emit('get_value_change', output);
        return output;
      },
      html_validate(input_value) {
        this.input_value = input_value.trim();
        this.value_change(input_value);
        const requestOptions = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
          },
          body: JSON.stringify(
            {str: input_value}
          ),
        };
        fetch('/editorial/html-validate', requestOptions)
          .then(async response => {
            const data = await response.json();
            // check for error response
            if (!response.ok) {
              // get error message from body or default to response status
              const error = (data && data.message) || response.status;
              return Promise.reject(error);
            }
            this.is_valid_html = data.ok;
            this.errors = data.errors;
            this.$emit('get_validation_errors', this.errors);
          })
          .catch(error => {
            this.errorMessage = error;
            console.error('There was an error!', error);
          }
        );
      },
    },
  }
); 

var vc_meta_json_form = Vue.component(
  'meta-json-form',
  {
    delimiters: ['[[', ']]'],
    props: ['meta_json', 'meta_configs', 'item_id', 'add_new'],
    data() {
      return {
        meta_configs: null,
        meta_json: null,
        item_id: null,
        add_new: false,
      };
    },
    template: '#meta-json-form',
    created() {
      
    },
    computed: {
      
    },
    methods: {
      get_value_change(change) {
        console.log('event get_value_change');
        console.log(change);
      },
    },
    components: {
      'meta-json-form-item': vc_meta_json_form_item,
    },
  }
); 
  
</script>