{% load humanize %}

<!-- 
NOTE: Templates and view components to edit an item's manifest object.
-->

<style>
 .field_row {
   margin-top: 48px;
 }
</style>



<template id="edit-manifest">
  <b-container fluid v-if="man_obj">
    <b-row>
      <b-col cols="12"> 
        <b-alert show>

          <b-row>
            <b-col cols="12">
              <h5><strong>Edit </strong> [[ man_obj.label ]]</h5>
              <p><small><strong>UUID: </strong>[[ man_obj.uuid ]]</small></p>
              <p><small><strong>Slug: </strong>[[ man_obj.slug ]]</small></p>
            </b-col>
          </b-row>

          <b-row>
            <b-col cols="12">
              <p v-if="web_url">
                <strong>URI <b-icon-files></b-icon-files>: </strong>
                <a :href="web_url" target="_blank">[[ web_url ]]</a>
              </p>
            </b-col>
          </b-row>

          <b-row>
            <b-col cols="4">
              <p><strong>Item Type: </strong> [[ man_obj.item_type ]]</p>
            </b-col>
            <b-col cols="8">
              <small>[[ ITEM_TYPE_EDIT_CONFIG.item_type_note ]]</small>
            </b-col>
          </b-row>

        </b-alert>
      </b-col>
    </b-row>
    <edit-manifest-obj
      v-bind:add_new="false"
      v-bind:item_type_config="ITEM_TYPE_EDIT_CONFIG"
      v-bind:project_ids="ITEM_PROJECT_UUIDS"
      v-bind:man_obj="man_obj">
    </edit-manifest-obj>
  </b-container>
</template>


<script type="text/javascript">

const ITEM_TYPE_EDIT_CONFIG = JSON.parse('{{ ITEM_TYPE_EDIT_CONFIG|escapejs }}');
const DEFAULT_CLASS = JSON.parse('{{ DEFAULT_CLASS|escapejs }}');

    var vc_edit_manifest = Vue.component(
        'edit-manifest',
        {
          delimiters: ['[[', ']]'],
          props: ['uuid', ],
          data() {
            return {
              uuid: null,
              man_obj: null,
            }
          },
          template: '#edit-manifest',
          created() {
            this.fetch_api_manifest_obj();
          },
          computed: {
            web_url: function() {
              if(!this.man_obj || !this.man_obj.uri){
                return null;
              }
              let url = this.trim_prefix(this.man_obj.uri, 'https://');
              return 'https://' + this.trim_prefix(url, 'http://');
            },
          },
          methods: {
            fetch_api_manifest_obj: function (){
              this.error = null;
              this.loading = true;
              fetch(
                ('/editorial/item-manifest/' + this.uuid),
                  {
                    headers:{
                        'Accept': 'application/json',
                    }
                  }
              )
              .then(this.loading = false)
              .then(response => response.json())
              .then(json => {
                  this.man_obj = json;
                  console.log(this.man_obj);
              })
            },
            send_manifest_update_request(requestOptions){
              // Actually sends the request to update the manifest object.
              fetch('/editorial/item-update-manifest', requestOptions)
              .then(async response => {
                const data = await response.json();
                // check for error response
                if (!response.ok) {
                  // get error message from body or default to response status
                  const error = (data && data.message) || response.status;
                  return Promise.reject(error);
                }
                // Share the news we just did an edit
                this.$emit('edit_done', true);
                // Reload the item.
                this.fetch_api_manifest_obj();
              })
              .catch(error => {
                this.errorMessage = error;
                console.error('There was an error!', error);
              });
            },
            update_item_label() {
              if(!this.new_label){
                console.log("No new label defined, will not update.");
                return null;
              }
              const requestOptions = {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify(
                  [
                    { uuid: this.uuid, label: this.new_label }
                  ]
                )
              };
              this.send_manifest_update_request(requestOptions);
            },
            update_item_class() {
              if(typeof(this.selected_class_item) == 'undefined' ){
                console.log("None selected, don't update item_class");
                return null;
              }
              const requestOptions = {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify(
                  [
                    { uuid: this.uuid, item_class_id: this.selected_class_item.uuid }
                  ]
                )
              };
              this.send_manifest_update_request(requestOptions);
            },
            update_item_context() {
              if(typeof(this.selected_context_item) == 'undefined' ){
                console.log("None selected, don't update context");
                return null;
              }
              const requestOptions = {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify(
                  [
                    { uuid: this.uuid, context_id: this.selected_context_item.uuid }
                  ]
                )
              };
              this.send_manifest_update_request(requestOptions);
            },
            update_item_project() {
              if(typeof(this.selected_project_item) == 'undefined' ){
                console.log("None selected, don't update project");
                return null;
              }
              const requestOptions = {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify(
                  [
                    { uuid: this.uuid, project_id: this.selected_project_item.uuid }
                  ]
                )
              };
              this.send_manifest_update_request(requestOptions);
            },
            update_metadata(meta_json){
              const requestOptions = {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
              },
              body: JSON.stringify(
                [
                  { uuid: this.uuid, meta_json: meta_json}
                ]
              )
              };
              this.send_manifest_update_request(requestOptions);
            },
            trim_prefix(str, prefix) {
              if (str.startsWith(prefix)) {
                  return str.slice(prefix.length);
              } else {
                  return str;
              }
            },
            uri_change(input_value) {
              input_value = this.trim_prefix(input_value, 'https://');
              input_value = this.trim_prefix(input_value, 'http://');
              return input_value;
            },
          },
          components: {
            'edit-manifest-obj': vc_edit_manifest_obj,
          },
        }
    ); 
  
  </script>