{% block search_tabs %}

<template id="all-search-tabs-temp">
  <div>
    <b-card no-body>
      <b-tabs card v-model="tab" @input="input_int_tab_clicked" :ref="'search-tabs'">
        <b-tab title="Mapped Results" 
          :id="tab_ids[0]"
          :key="tab_ids[0]"
          @click="tab_clicked"
          >
          <b-card-text>
            <h5 v-if="result">
              <span class="text-left">Summary Map of</span>
              <span class="text-right">[[ result_count_human ]] Records</span>
            </h5>
            <h5 v-else>
                <span class="text-left">Map</span>
                <span class="text-right">Loading Records...</span>
            </h5>
            <div id="app_media" v-if="result && tab == 0">
              <common_map
                :map_key="0"
                :map_class="'map_preview'"
                :map_type="'search'"
                :min_height="800"
                :ref_suffix="'search-map'"
                :show_default_overlay="false"
                v-bind:frontend_state_obj="frontend_state_obj"
                v-bind:route_key_index="route_key_index"
                v-bind:geo_json="result"
                v-bind:geo_overlays="project_image_overlays"
                @set_frontend_state_obj="set_frontend_state_obj($event)"
                ></common_map>
            </div>
            <div class="jumbotron jumbotron-fluid" v-else>
                <div class="container-fluid text-muted text-center">
                  <h1 class="display-4">Preparing data...</h1>
                  <b-spinner class="m-5" label="Busy"></b-spinner>
                </div>
            </div>
            
          </b-card-text>
        </b-tab>

        <b-tab 
          title="Time Ranges"
          :id="tab_ids[1]"
          :key="tab_ids[1]"
          :disabled="!chrono_facets"
          @click="tab_clicked"
          >
          <b-card-text v-if="chrono_facets && tab == 1">

            <chronotiles
              :key="'chrono-tiles-component-' + route_key_index"
              v-bind:result_id="result.id"
              v-bind:chrono_facets="chrono_facets"></chronotiles>

          </b-card-text>
        </b-tab>



        <b-tab 
          title="Charts"
          :id="tab_ids[2]"
          :key="tab_ids[2]"
          :disabled="disable_charts_tab"
          @click="tab_clicked"
          >
          <b-card-text v-if="facets_numeric_groups_opts && tab == 2">

            <all-numeric-facets
              v-bind:route_key_index="route_key_index"
              v-bind:frontend_state_obj="frontend_state_obj"
              v-bind:result_id="result.id"
              v-bind:all_range_facets="all_range_facets"
              v-bind:facets_numeric_groups_opts="facets_numeric_groups_opts"
              v-bind:facets_int_groups_opts="facets_int_groups_opts"
              v-bind:facets_double_groups_opts="facets_double_groups_opts"
              v-bind:facets_date_groups_opts="facets_date_groups_opts"
            ></all-numeric-facets>

          </b-card-text>
        </b-tab>

        <b-tab 
          title="Item Records"
          :id="tab_ids[3]"
          :key="tab_ids[3]"
          :disabled="!(result_count > 0)"
          @click="tab_clicked"
          >
          <b-card-text v-if="result_count > 0 && tab == 3">
            <records-tab
              v-bind:frontend_state_obj="frontend_state_obj"
              v-bind:route_key_index="route_key_index"
              v-bind:result_id="result.id"
              v-bind:result_count="result_count"
              v-bind:result_start_index="result_start_index"
              v-bind:result_items_per_page="result_items_per_page"
              v-bind:result_page_first_link="result_page_first_link"
              v-bind:result_page_previous_link="result_page_previous_link"
              v-bind:result_page_next_link="result_page_next_link"
              v-bind:result_page_last_link="result_page_last_link"
              v-bind:descriptiveness_min="descriptiveness_min"
              v-bind:descriptiveness_max="descriptiveness_max"
              v-bind:result_raw_features="result_raw_features"
            ></records-tab>

          </b-card-text>
        </b-tab>

      </b-tabs>
    </b-card>
  </div>
</template>


<script type="text/javascript">

var vc_all_search_tabs = Vue.component(
    'all-search-tabs',
    {
      delimiters: ['[[', ']]'],
      props: [
        'result',
        'chrono_facets',
        'route_key_index',
        'frontend_state_obj',
        'start_full_path',
        'tab',
      ],
      template: '#all-search-tabs-temp',
      data() {
        return {
          message: 'Open Context Search Result',
          tabs_ref: 'search-tabs',
          result: null,
          emit_update_fetch_done: false,
          route_key_index: 0,
          tab: null,
          frontend_state_obj: {},
          tab_ids: [
            'tab-map',
            'tab-time-ranges',
            'tab-numeric-fields',
            'tab-item-records',
          ],
          map_tab: 0,
        };
      },
      mounted(){
        this.activate_tab_from_frontend_state_obj();
      },
      computed: {
        map_time_id: function () {
          let frag_obj = get_search_current_frag_obj();
          frag_obj.tab = 'map-time-ranges';
          // return encode_frag_obj(frag_obj);
          return frag_obj.tab;
        },
        result_count: function() {
          return safe_get_nested_object_by_str_key(this.result, 'totalResults');
        },
        result_count_human: function(){
          let result_count = safe_get_nested_object_by_str_key(this.result, 'totalResults');
          if(!result_count){
            return '(No records returned)';
          }
          return result_count.toLocaleString();
        },
        result_start_index: function() {
          return safe_get_nested_object_by_str_key(this.result, 'startIndex');
        },
        result_items_per_page: function() {
          return safe_get_nested_object_by_str_key(this.result, 'itemsPerPage');
        },
        result_page_first_link: function() {
          let act_link = safe_get_nested_object_by_str_key(this.result, 'first');
          return abs_to_rel_url_with_frag_obj(act_link, BASE_URL, this.frontend_state_obj);
        },
        result_page_previous_link: function() {
          let act_link = safe_get_nested_object_by_str_key(this.result, 'previous');
          return abs_to_rel_url_with_frag_obj(act_link, BASE_URL, this.frontend_state_obj);
        },
        result_page_next_link: function() {
          let act_link = safe_get_nested_object_by_str_key(this.result, 'next');
          return abs_to_rel_url_with_frag_obj(act_link, BASE_URL, this.frontend_state_obj);
        },
        result_page_last_link: function() {
          let act_link = safe_get_nested_object_by_str_key(this.result, 'last');
          return abs_to_rel_url_with_frag_obj(act_link, BASE_URL, this.frontend_state_obj);
        },
        descriptiveness_min: function() {
          return safe_get_nested_object_by_str_key(this.result, 'oc-api:descriptiveness-min');
        },
        descriptiveness_max: function() {
          return safe_get_nested_object_by_str_key(this.result, 'oc-api:descriptiveness-max');
        },
        project_image_overlays: function() {
          let raw_overlays = safe_get_nested_object_by_str_key(
            this.result, 
            'oc-api:oc-gen-has-geo-overlays'
          );
          if(!raw_overlays){
            return null;
          }
          console.log('raw overlay count: ' + raw_overlays.length);
          let overlays = [];
          for(let overlay_obj of raw_overlays){
            if(!overlay_obj.hasOwnProperty('oc-api:leaflet')){
              continue;
            }
            let overlay = overlay_obj['oc-api:leaflet'];
            overlay.zIndex = -1;
            overlays.push(overlay);
          }
          return overlays;
        },
        result_raw_features: function() {
          return safe_get_nested_object_by_str_key(this.result, 'features');
        },
        numeric_fields_id: function () {
          let frag_obj = get_search_current_frag_obj();
          frag_obj.tab = 'numeric-fields';
          // return encode_frag_obj(frag_obj);
          return frag_obj.tab;
        },
        facets_numeric_groups_opts: function() {
            // Group facet fields and options
            // returned from the API
            if(!this.result){
              return [];
            }
            // return null;
            let charts_opts = prepare_facets_dtypes_groups_opts_by_data_types(
              this.result,
              ['int', 'double', 'date']
            );
            if(charts_opts == null){
              return [];
            }
            return charts_opts;
        },
        disable_charts_tab: function() {
          for(let f_obj of this.facets_numeric_groups_opts){
            if(f_obj.dtypes_groups_opts.length > 0){
              return false;
            }
          }
          let ranges = safe_get_nested_object_by_str_key(this.result, 'oc-api:has-range-facets');
          if(ranges){
            return false;
          }
          return true;
        },  
        facets_int_groups_opts: function() {
            // Group facet fields and options
            // returned from the API
            if(!this.result){
              return null;
            }
            let facet_opts = prepare_facets_dtypes_groups_opts_by_data_types(
              this.result,
              ['int',],
              frontend_state_obj=this.frontend_state_obj,
            );
            return facet_opts;
        },
        facets_double_groups_opts: function() {
            // Group facet fields and options
            // returned from the API
            if(!this.result){
              return null;
            }
            return prepare_facets_dtypes_groups_opts_by_data_types(
              this.result,
              ['double',],
              frontend_state_obj=this.frontend_state_obj,
            );
        },
        facets_date_groups_opts: function() {
            // Group facet fields and options
            // returned from the API
            if(!this.result){
              return null;
            }
            return prepare_facets_dtypes_groups_opts_by_data_types(
              this.result,
              ['date',],
              frontend_state_obj=this.frontend_state_obj,
            );
        },
        all_range_facets: function () {
          if(!this.result){
            return null;
          }
          if (!('oc-api:has-range-facets' in this.result)){
            // Nothing to do, so skip out.
            return null;
          }
          return this.result['oc-api:has-range-facets'];
        },
      },
      methods: {
        activate_tab_from_frontend_state_obj: function() {
          if(this.frontend_state_obj == null){
            console.log('cannot activate inital tab, no state obj');
            this.tab = 0;
            return null;
          }
          if(!('tab' in this.frontend_state_obj)){
            console.log('cannot find tab key in state obj');
            this.tab = 0;
            this.frontend_state_obj.tab = this.tab;
            this.$emit('set_frontend_state_obj', this.frontend_state_obj);
            return null;
          }
          let initial_tab = parseInt(this.frontend_state_obj.tab);
          console.log('Activate initial tab: ' + initial_tab);
          this.tab = initial_tab;
          setTimeout(() => {  
            this.input_int_tab_clicked(initial_tab);
            this.tab = initial_tab;
          }, 200);
          this.tab = initial_tab;
        },
        input_int_tab_clicked: function(t_id){
          if(t_id == null){
            return null;
          }
          let temp_t_id = 0;
          if(window.location.hash){
            let act_frag_str =  window.location.hash.substring(1);
            let act_frag_tab = get_search_frag_key('tab', act_frag_str);
            if(act_frag_tab != null){
              temp_t_id = parseInt(act_frag_tab);
            }
          }
          this.tab = temp_t_id;
          // this.set_frontend_state_obj(act_frontend_state);
          // window.dispatchEvent(new Event('resize'));
        },
        tab_clicked: function(t_id){
          if(this.tab == null || this.tab < 0){
            console.log('Fake Tab clicked: ' + this.tab);
            return null;
          }
          // console.log('tab click event');
          // console.log(t_id);
          if(typeof(t_id) === 'number'){
            this.input_int_tab_clicked(t_id);
            return null;
          }
          let found_tab = null;
          for(let i = 0; i < this.tab_ids.length; i++){
            let act_id = this.tab_ids[i];
            if(!t_id.target == null){
              continue;
            }
            if(t_id.target.id.indexOf(act_id)>=0){
              // we found the id of passed from the click event.
              // console.log('pointer event match tab ' + i);
              found_tab = i;
            }
          }
          if(found_tab == null){
            return null;
          }
          this.tab = found_tab;
          // window.dispatchEvent(new Event('resize'));
          let act_frontend_state = JSON.parse(JSON.stringify(this.frontend_state_obj));
          act_frontend_state.tab = found_tab;
          this.set_frontend_state_obj(act_frontend_state);
          setTimeout(() => {  
            this.input_int_tab_clicked(found_tab);
            this.tab = found_tab;
          }, 200);
          return null;
        },
        set_frontend_state_obj(frontend_state_obj){
          if(frontend_state_obj){
            // console.log('tab update to frontend state');
            // console.log(frontend_state_obj);
            this.$emit('set_frontend_state_obj', frontend_state_obj);
          }
        },
      },
      components: {
        'common_map': vc_common_map,
        'chronotiles': vc_chronotiles,
        'all-numeric-facets': vc_all_numeric_facets,
        'records-tab': vc_records_tab,
      }
    }
);

</script>

{% endblock %}