{% block search_tabs %}

<template id="all-search-tabs-temp">
  <div>
    <b-card no-body>
      <b-tabs card v-model="tab" @input="tab_clicked">
        <b-tab title="Map and Time Ranges" 
          :id="'tab-map-time-ranges'"
          >
          <b-card-text>
            <h5 v-if="result">
              <span class="text-left">Map</span>
              <span class="text-right">[[ result['totalResults'] ]] Records</span>
            </h5>
            <h5 v-else>
                <span class="text-left">Map</span>
                <span class="text-right">Loading Records...</span>
            </h5>
            <div id="app_media" v-if="result">
              <common_map
                :map_key="0"
                :map_class="'map_preview'"
                :min_height="800"
                :ref_suffix="'search-map'"
                v-bind:route_key_index="route_key_index"
                v-bind:geo_json="result"></common_map>
            </div>
            <div class="jumbotron jumbotron-fluid" v-else>
                <div class="container-fluid text-muted text-center">
                  <h1 class="display-4">Getting map data...</h1>
                  <b-spinner class="m-5" label="Busy"></b-spinner>
                </div>
            </div>
            <div v-if="chrono_facets">
              <chronotiles
                  :key="'chrono-tiles-component-' + route_key_index"
                  v-bind:result_id="result.id"
                  v-bind:chrono_facets="chrono_facets"></chronotiles>
            </div>
          </b-card-text>
        </b-tab>
        <b-tab 
          title="Charts"
          :id="'tab-numeric-fields'"
          >
          <b-card-text v-if="facets_numeric_groups_opts">

            <all-numeric-facets
              v-bind:route_key_index="route_key_index"
              v-bind:result_id="result.id"
              v-bind:all_range_facets="all_range_facets"
              v-bind:facets_numeric_groups_opts="facets_numeric_groups_opts"
              v-bind:facets_int_groups_opts="facets_int_groups_opts"
              v-bind:facets_double_groups_opts="facets_double_groups_opts"
              v-bind:facets_date_groups_opts="facets_date_groups_opts"
            ></all-numeric-facets>

          </b-card-text>
        </b-tab>

        <b-tab 
          title="Item Records"
          :id="'tab-item-records'"
          >
          <b-card-text v-if="result_count > 0">
            <records-tab
              v-bind:route_key_index="route_key_index"
              v-bind:result_id="result.id"
              v-bind:result_count="result_count"
              v-bind:result_start_index="result_start_index"
              v-bind:result_items_per_page="result_items_per_page"
              v-bind:result_page_first_link="result_page_first_link"
              v-bind:result_page_previous_link="result_page_previous_link"
              v-bind:result_page_next_link="result_page_next_link"
              v-bind:result_page_last_link="result_page_last_link"
              v-bind:descriptiveness_min="descriptiveness_min"
              v-bind:descriptiveness_max="descriptiveness_max"
              v-bind:result_raw_features="result_raw_features"
            ></records-tab>

          </b-card-text>
        </b-tab>

      </b-tabs>
    </b-card>
  </div>
</template>


<script type="text/javascript">

var vc_all_search_tabs = Vue.component(
    'all-search-tabs',
    {
      delimiters: ['[[', ']]'],
      props: [
        'result',
        'chrono_facets',
        'route_key_index',
        'frontend_state_obj',
        'tab',
      ],
      template: '#all-search-tabs-temp',
      data() {
        return {
          message: 'Open Context Search Result',
          result: null,
          tile_layer: null,
          emit_update_fetch_done: false,
          route_key_index: 0,
          tab: null,
          frontend_state_obj: null,
        };
      },
      computed: {
        map_time_id: function () {
          let frag_obj = get_search_current_frag_obj();
          frag_obj.tab = 'map-time-ranges';
          // return encode_frag_obj(frag_obj);
          return frag_obj.tab;
        },
        result_count: function() {
          return safe_get_nested_object_by_str_key(this.result, 'totalResults');
        },
        result_start_index: function() {
          return safe_get_nested_object_by_str_key(this.result, 'startIndex');
        },
        result_items_per_page: function() {
          return safe_get_nested_object_by_str_key(this.result, 'itemsPerPage');
        },
        result_page_first_link: function() {
          return safe_get_nested_object_by_str_key(this.result, 'first');
        },
        result_page_previous_link: function() {
          return safe_get_nested_object_by_str_key(this.result, 'previous');
        },
        result_page_next_link: function() {
          return safe_get_nested_object_by_str_key(this.result, 'next');
        },
        result_page_last_link: function() {
          return safe_get_nested_object_by_str_key(this.result, 'last');
        },
        descriptiveness_min: function() {
          return safe_get_nested_object_by_str_key(this.result, 'oc-api:descriptiveness-min');
        },
        descriptiveness_max: function() {
          return safe_get_nested_object_by_str_key(this.result, 'oc-api:descriptiveness-max');
        },
        result_raw_features: function() {
          return safe_get_nested_object_by_str_key(this.result, 'features');
        },
        numeric_fields_id: function () {
          let frag_obj = get_search_current_frag_obj();
          frag_obj.tab = 'numeric-fields';
          // return encode_frag_obj(frag_obj);
          return frag_obj.tab;
        },
        facets_numeric_groups_opts: function() {
            // Group facet fields and options
            // returned from the API
            if(!this.result){
              return null;
            }
            // return null;
            return prepare_facets_dtypes_groups_opts_by_data_types(
              this.result,
              ['int', 'double', 'date']
            );
        },
        facets_int_groups_opts: function() {
            // Group facet fields and options
            // returned from the API
            if(!this.result){
              return null;
            }
            let facet_opts = prepare_facets_dtypes_groups_opts_by_data_types(
              this.result,
              ['int',]
            );
            console.log('Integer facets');
            console.log(facet_opts);
            return facet_opts;
        },
        facets_double_groups_opts: function() {
            // Group facet fields and options
            // returned from the API
            if(!this.result){
              return null;
            }
            return prepare_facets_dtypes_groups_opts_by_data_types(
              this.result,
              ['double',]
            );
        },
        facets_date_groups_opts: function() {
            // Group facet fields and options
            // returned from the API
            if(!this.result){
              return null;
            }
            return prepare_facets_dtypes_groups_opts_by_data_types(
              this.result,
              ['date',]
            );
        },
        all_range_facets: function () {
          if(!this.result){
            return null;
          }
          if (!('oc-api:has-range-facets' in this.result)){
            // Nothing to do, so skip out.
            return null;
          }
          return this.result['oc-api:has-range-facets'];
        },
      },
      methods: {
        tab_clicked(){
          console.log('Tab clicked: ' + this.tab);
          if(!this.frontend_state_obj){
            this.frontend_state_obj = {};
          }
          this.frontend_state_obj.tab = this.tab;
          window.dispatchEvent(new Event('resize'));
          this.$emit('set_frontend_state_obj', this.frontend_state_obj);
          return null;
        }
      },
      components: {
        'common_map': vc_common_map,
        'chronotiles': vc_chronotiles,
        'all-numeric-facets': vc_all_numeric_facets,
        'records-tab': vc_records_tab,
      }
    }
);

</script>

{% endblock %}