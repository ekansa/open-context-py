{% load humanize %}


<template id="filter-list-template">

<div class="card bg-light" id="acc-filters">
    <div class="card-header"> 
        <h5 class="filter_heading_labels">
            Applied Filters
        </h5>
    </div>
        
    <div class="card-body small">
        <div v-if="grouped_filters">
            <div v-if="grouped_filters.length">
                <filter-item
                    v-for="(filter_group, index) in grouped_filters"
                    v-bind:key="filter_group.key"
                    v-bind:filter_group="filter_group"
                    v-bind:index="index"
                ></filter-item>
            </div>
            <p v-else>
                No filters currently in use. Select query options below.
            </p>
        </div>
        <div v-else>
            <b-spinner class="m-5" label="Busy"></b-spinner>
            <p>Listing filters currently in use...</p>
        </div>
    </div>
        
</div>

</template>


<template id="filter-item-template">
<div>
    <div class="row act-filter-type">
        <div class="col-12">
            <strong>[[ filter_group.label ]]</strong>
        </div>
    </div>
    <div class="row act-filter-val-row">
        <div class="col-1">
            <router-link title="Remove this filter" :to="filter_group.remove_href">
                <b-icon-x-circle-fill></b-icon-x-circle-fill>
            </router-link>
        </div>
        <div class="col-10 act-filter-val"> 
            <span v-for="(filter, index) in filter_group.filters">
                <span v-if="index != 0">[[filter_group.path_delim]]</span>
                <!-- 
                    <a :title="'Broaden to all: ' + filter.label" :href="filter['oc-api:broaden']">[[filter.label]]</a>
                -->

                <router-link v-if="filter['oc-api:broaden']" :title="'Broaden to all: ' + filter.label" :to="filter['oc-api:broaden']">[[filter.label]]</router-link>
                <span v-if="!filter['oc-api:broaden']">[[filter.label]]</span>
            </span>
        </div>
        <div class="col-1">
        </div>
    </div>
</div>
</template>


<script type="text/javascript">

// Passed from the Django template
var DEFAULT_FILTER_GROUP_DELIM = '{{ configs.FILTER_HIERARCHY_DEFAULT_DELIM }}';
var FILTER_HIERARCHY_DELIMS = {{ configs.FILTER_HIERARCHY_DELIMS|safe }} ;

var vc_filter_item = Vue.component(
    'filter-item',
    {
        delimiters: ['[[', ']]'],
        props: ['filter_group', 'index', 'allow_collapse'],
        data: {
            allow_collapse: false,
        },
        template: '#filter-item-template',
    }
);
var vc_all_filters = Vue.component(
    'all-filters',
    {
        delimiters: ['[[', ']]'],
        props: ['grouped_filters'],
        template: '#filter-list-template',
        components: {
            'filter-item': vc_filter_item
        }
    }
);


function make_broaden_link_with_last_hash(raw_filter){
    let broaden_link = abs_to_rel_url(raw_filter['oc-api:broaden'], BASE_URL);
    if(raw_filter["oc-api:filter-group"].indexOf("---") < 0){
        return broaden_link + '#' + raw_filter["oc-api:filter-slug"];
    }
    let prefix_parts = raw_filter["oc-api:filter-group"].split('---');
    let act_prefix = prefix_parts[0];
    if(act_prefix == raw_filter["oc-api:filter-slug"]){
        return update_search_url_frag_key_val(broaden_link, "aq", act_prefix);
    }
    return update_search_url_frag_key_val(
        broaden_link, 
        "aq", 
        (act_prefix + '---' + raw_filter["oc-api:filter-slug"])
    );
}


function group_filters(result){
    console.log(result);
    var grouped_filters = []; //main output.
    var group_keys = []; //used for ordering filter groups predictably
    var temp_groups = {}; //used for grouping filters togther.
    if (!('oc-api:active-filters' in result)){
        return grouped_filters;
    }
    for (let raw_filter of result['oc-api:active-filters']){
        console.log(raw_filter);
        var group_key = null;
        if (!('oc-api:filter-group' in raw_filter)){
            group_key = raw_filter['id'];
        }
        else{
            group_key = raw_filter['oc-api:filter-group'];
        }
        if(!(group_key in temp_groups)){
            group_keys.push(group_key);
            var path_delim = DEFAULT_FILTER_GROUP_DELIM;
            if((raw_filter['oc-api:filter'] in FILTER_HIERARCHY_DELIMS)){
                path_delim = FILTER_HIERARCHY_DELIMS[raw_filter['oc-api:filter']];
            }
            temp_groups[group_key] = {
                'label': raw_filter['oc-api:filter'],
                'key': abs_to_rel_url(raw_filter['oc-api:remove'], BASE_URL),
                'remove_href': abs_to_rel_url(raw_filter['oc-api:remove'], BASE_URL),
                'path_delim': path_delim,
                'filters': []
            };
        }
        if(('oc-api:broaden' in raw_filter)){
            raw_filter['key'] =  abs_to_rel_url(raw_filter['oc-api:broaden'], BASE_URL);
            raw_filter['oc-api:broaden'] = make_broaden_link_with_last_hash(raw_filter);
        }
        temp_groups[group_key]['filters'].push(raw_filter);
    }
    // Order by the order of group_keys list.
    for (let group_key of group_keys){
        var filter_group = temp_groups[group_key];
        grouped_filters.push(filter_group);
    }
    return grouped_filters;
}

</script>