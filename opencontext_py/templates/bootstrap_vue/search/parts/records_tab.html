{% load humanize %}


<template id='records-tab-field-label'>
    <div>
        <a v-if="field_item.href"
            :href="field_item.href"
            :title="'Link to ' + field_item.label"
            target="_blank">
            [[ field_item.label ]]
        </a>
        <span v-else>
            (Loading...)
        </span>
    </div>
</template>



<template id='records-tab-field-descriptiveness'>
    <div class="clearfix record-thumb-outer">
    <b-img-lazy 
        v-if="field_item.media" 
        :src="field_item.media"
        thumbnail
        fluid
        rounded
        center
        :alt="'Image related to ' + field_item.label">
    </b-img-lazy>
    <b-img v-else
        v-bind="blank_props"
        blank-color="#cccccc"
        center
        :alt="'No image related to ' + field_item.label">
    </b-img>
    </div>
</template>



<template id="records-tab-template">

    <div id="search-records-tab">
        <h5 class="filter_heading_labels">
            Search Results [[ view_range_note ]]
        </h5>

        <b-table 
            v-if="result_raw_features"
            :items="items"
            :fields="fields"
            :striped="striped"
            :bordered="bordered"
            responsive="xl"
            :small="true"
            selectable
            hover
            @row-selected="onRowSelected"
            no-local-sorting
            @sort-changed="sortingChanged"
            sort-icon-left
            :sort-by.sync="sortBy"
            :sort-desc.sync="sortDesc"
        >
            <template #cell(label)="data">
                <records-tab-field-label
                v-bind:field_item="data.item">
                </records-tab-field-label>
            </template>

            <template #cell(descriptiveness)="data">
                <records-tab-field-descriptiveness
                v-bind:field_item="data.item">
                </records-tab-field-descriptiveness>
            </template>

            <template #cell()="data">
                [[ data.value ]]
            </template>

        </b-table>
        <div v-else>
            <b-spinner class="m-5" label="Busy"></b-spinner>
            <p>Getting item records...</p>
        </div>

    </div>

</template>






<style type="text/css">


</style>


<script type="text/javascript">


const SORT_OPTIONS_FRONTEND = JSON.parse('{{ SORT_OPTIONS_FRONTEND|escapejs }}');


var vs_records_tab_field_label = Vue.component(
    'records-tab-field-label',
    {
      delimiters: ['[[', ']]'],
      props: ['field_item', ],
      data() {
        return {
            field_item: null,
        };
      },
      template: '#records-tab-field-label',
      methods: {
        
      }
    },
);


var vs_records_tab_field_descriptiveness = Vue.component(
    'records-tab-field-descriptiveness',
    {
      delimiters: ['[[', ']]'],
      props: ['field_item', ],
      data() {
        return {
            field_item: null,
            blank_props: {
                blank: true, 
                width: 75, 
                height: 75, 
                class: 'm1',
            },
        };
      },
      template: '#records-tab-field-descriptiveness',
      methods: {
        
      }
    },
);



var vc_records_tab = Vue.component(
    'records-tab',
    {
        delimiters: ['[[', ']]'],
        props: [
            'all_range_facets',
            'route_key_index',
            'frontend_state_obj',
            'result_id',
            'result_count',
            'result_start_index',
            'result_items_per_page',
            'result_page_first_link',
            'result_page_previous_link',
            'result_page_next_link',
            'result_page_last_link',
            'descriptiveness_min',
            'descriptiveness_max',
            'result_raw_features',
        ],
        data() {
            return {
                frontend_state_obj: {},
                striped: true,
                bordered: true,
                selectMode: 'single',
                result_id: null,
                all_range_facets: null,
                route_key_index: 0,
                result_count: 0,
                result_start_index: 0,
                result_items_per_page: 1,
                result_page_first_link: null,
                result_page_previous_link: null,
                result_page_next_link: null,
                result_page_last_link: null,
                descriptiveness_min: 0,
                descriptiveness_max: 0,
                interest_levels: 5,
                result_raw_features: null,
                sortBy: 'descriptiveness',
                sortDesc: true,
                fields: [
                    { key: 'descriptiveness', sortable: true, label: 'Info Content'},
                    { key: 'item_class', sortable: true, label: 'Category' },
                    { key: 'label', sortable: true, label: 'Item'},
                    { key: 'project', sortable: true },
                    { key: 'context', sortable: true },
                    { key: 'chronology', sortable: false },
                    { key: 'updated', sortable: true },
                ],
                selected: [],
            };
        },
        template: '#records-tab-template',
        mounted() {
            
        },
        computed: {
            view_range_note: function() {
                if(this.result_count < 1 || this.result_count == null){
                    return 'Current filters return no items';
                }
                if(this.result_start_index == null || this.result_items_per_page == null){
                    return 'Error. Please change filter criteria.';
                }
                let first_index = this.result_start_index + 1;
                let last_index = this.result_start_index + this.result_items_per_page;
                if(last_index > this.result_count){
                    last_index = this.result_count;
                }
                return `${first_index.toLocaleString()} to ${last_index.toLocaleString()} of ${this.result_count.toLocaleString()}`;
            },
            items: function () {
                if(!this.result_raw_features){
                    return null;
                }
                let items = [];
                for(let feature of this.result_raw_features){
                    if(feature['category'] != 'oc-api:geo-record'){
                        continue;
                    }
                    if(!('properties' in feature)){
                        continue;
                    }
                    
                    let props = feature['properties'];
                    let url = feature['rdfs:isDefinedBy'];
                    url = abs_to_rel_url(url, BASE_URL);

                    let href = url;
                    if('href' in props){
                        href = props['href'];
                    }

                    let context = '(No spatial context)';
                    let context_url = null;
                    if('context label' in props){
                        context = props['context label'];
                    }
                    if('context href' in props){
                        context_url = abs_to_rel_url(
                            props['context href'],
                            BASE_URL,
                        );
                    }
                    let item_class = '(Uncateorized)';
                    if('item category' in props){
                        item_class = props['item category'];
                    }
                    let early = null;
                    let late = null;
                    let dates = null;
                    if('early bce/ce' in props){
                        early = style_bce_ce_year(props['early bce/ce'], null);
                    }
                    if('late bce/ce' in props){
                        late = style_bce_ce_year(props['late bce/ce'], null);
                    }
                    if((early != null) && (late != null)){
                        dates = early + ' to ' + late;
                    }
                    else if(early != null){
                        dates = early;
                    }
                    else if(late != null){
                        dates = late;
                    }
                    else {
                        dates = '(No dates)';
                    }
                    let thumb_uri = null;
                    if('thumbnail' in props){
                        thumb_uri = props['thumbnail'];
                    }
                    let updated = props['updated'];
                    let updated_ex = updated.split('T');
                    updated = updated_ex[0];

                    let item = {
                        label: feature['label'],
                        url: url,
                        href: href,
                        item_class: item_class,
                        context: context,
                        context_url: context_url,
                        project: props['project label'],
                        project_url: abs_to_rel_url(
                            props['project href'],
                            BASE_URL,
                        ),
                        chronology: dates,
                        descriptiveness: this.interest_level(
                            feature['oc-api:descriptiveness'], 
                            this.descriptiveness_min, 
                            this.descriptiveness_max,
                        ),
                        updated: updated,
                        media: thumb_uri,
                    };
                    items.push(item);
                }
                return items;
            },
        },
        methods: {
            interest_level(des_act, des_min, dex_max){
                let level = 0;
                let increments = (dex_max - des_min) / this.interest_levels;
                for (let i = 1; i <= this.interest_levels; i++) {
                    let level_score = des_min + (increments * i);
                    if (des_act >= level_score){
                        level = i;
                    }
                }
                return level;
            },
            onRowSelected(items){
                this.selected = items;
                console.log(this.selected);
                window.open(items[0].href, "_blank");
            },
            sortingChanged(ctx){
                console.log(ctx);
                let current_url = this.result_id;
                if(!(ctx.sortBy in SORT_OPTIONS_FRONTEND)){
                    console.log(ctx.sortBy + ' needs config');
                    return null;
                }
                let sort_val = SORT_OPTIONS_FRONTEND[ctx.sortBy];
                if(ctx.sortDesc){
                    sort_val += '--desc';
                }
                else{
                    sort_val += '--asc';
                }
                if(sort_val == getURLParameter(this.result_id, 'sort')){
                    // no sort change.
                    return null;
                }
                let url = replaceURLparameter(current_url, 'sort', sort_val);
                let frag_str = encode_frag_obj(this.frontend_state_obj);
                console.log('Frag to add to sort url: ' + frag_str);
                if(frag_str.length > 1){
                    url += '#' + frag_str;
                }
                url = abs_to_rel_url(url, BASE_URL);
                router.push(url);
            },
        },
        components: {
            'records-tab-field-label': vs_records_tab_field_label,
            'records-tab-field-descriptiveness': vs_records_tab_field_descriptiveness,
        },
    }
);



</script>