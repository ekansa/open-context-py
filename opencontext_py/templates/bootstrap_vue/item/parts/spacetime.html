{% load humanize %}

<!-- 
NOTE: Templates and view components to edit an item's space-time (event) object.
-->


<template id='item_map'>
  <div v-if="GEO_JSON" class="card">
    <div class="card-header">
      <h5>Mapping Data</h5>
    </div>
    <div class="card-body">
      <l-map
        style="min-height: 300px;"
        :ref="'map-' + ITEM_UUID" 
        :zoom="11"
        :load-tiles-while-animating="true" 
        :load-tiles-while-interacting="true">
        <l-control-layers position="topright"></l-control-layers>
        <l-tile-layer
          v-for="tp in tileProviders"
          :key="tp.name"
          :name="tp.name"
          :visible="tp.visible"
          :url="tp.url"
          :attribution="tp.attribution"
          layer-type="base"></l-tile-layer>
        <l-geo-json
          :key="'geojson-' + ITEM_UUID + map_key"
          :ref="'geojson-' + ITEM_UUID"
          :options="options"
          v-bind:geojson="geo_json"
        >
        <l-popup></l-popup>
        </l-geo-json>
      </l-map>
    </div> 
  </div>
</template>



<div id="app">
  <item_map :map_key="0"></item_map>
</div>


<script type="text/javascript">

  // Import Vue2Leaflet components. 
  const GEO_JSON = JSON.parse('{{ GEO_JSON|escapejs }}');
  const item_json = JSON.parse('{{ item_json|escapejs }}');
  const ITEM_UUID = item_json.uuid;
  const l_popup = Vue.component('l-popup', window.Vue2Leaflet.LPopup);
  const l_tile_layer = Vue.component(
    'l-tile-layer', 
    window.Vue2Leaflet.LTileLayer,
  );
  const l_geo_json = Vue.component(
    'l-geo-json', 
    window.Vue2Leaflet.LGeoJson,
  );
  const l_control_layers = Vue.component(
    'l-control-layers', 
    window.Vue2Leaflet.LControlLayers,
  );
  const l_marker = Vue.component(
    'l-marker', 
    window.Vue2Leaflet.LMarker,
  );
  const l_map = Vue.component(
    'l-map', 
    window.Vue2Leaflet.LMap,
  );
  
  const MAPBOX_PUBLIC_ACCESS_TOKEN = '{{ MAPBOX_PUBLIC_ACCESS_TOKEN|escapejs }}';
  const TILE_PROVIDERS = [
    {
      name: 'OpenStreetMap',
      visible: true,
      id: 'osm',
      url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      attribution: '© <a target="_blank" href="http://osm.org/copyright">OpenStreetMap</a> contributors',
    },
    {
      name: 'OpenTopoMap',
      visible: false,
      id: 'otm',
      url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
      attribution: 'Map data: © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: © <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',
    },
    {
      name: 'MapBox Light',
      visible: false,
      id: 'mapbox-light',
      url: (
        'https://api.mapbox.com/styles/v1/mapbox/light-v10/tiles/{z}/{x}/{y}?access_token=' 
        + MAPBOX_PUBLIC_ACCESS_TOKEN
      ),
      attribution: 'Map data: © <a href="https://MapBox.com">MapBox.com</a>',
    },
    {
      name: 'MapBox Dark',
      visible: false,
      id: 'mapbox-dark',
      url: (
        'https://api.mapbox.com/styles/v1/mapbox/dark-v10/tiles/{z}/{x}/{y}?access_token='
        + MAPBOX_PUBLIC_ACCESS_TOKEN
      ),
      attribution: 'Map data: © <a href="https://MapBox.com">MapBox.com</a>',
    },
    {
      name: 'MapBox Satellite',
      visible: false,
      id: 'mapbox-satellite',
      url: (
        'https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token='
        + MAPBOX_PUBLIC_ACCESS_TOKEN
      ),
      attribution: 'Map data: © <a href="https://MapBox.com">MapBox.com</a>',
    }
  ];

var MAP_OBJ = null;
  // Now make a Vue component of for a leaflet map.
var vc_item_map = Vue.component(
  'item_map', 
  {
    props: ['map_key'],
    data() {
      return {
          // Map Options
          map_key: 0,
          zoom_def: 13,
          layers: [],
          selectedTileSet: TILE_PROVIDERS[0], 
          tileProviders: TILE_PROVIDERS,
          minZoom_def: 1,
          maxZoom_def: 30,
          show_mapsets_default: true,
          map_ref: ('map-' + ITEM_UUID),
          geojson_ref: ('geojson-' + ITEM_UUID),
          center: null,
          geo_json: null,
      };
    },
    template: '#item_map',
    created() {
      this.get_map_ref();
    },
    mounted() {
      this.get_map_ref();
      this.fit_bounds();
    },
    updated(){
      this.fit_bounds();
    },
    computed: {
      options() {
        return {
          onEachFeature: this.onEachFeatureFunction
        };
      },
      onEachFeatureFunction() {
        return (feature, layer) => {
          layer.bindPopup(
            `<dl class="row">
              <dt class="col-sm-4">Item</dt>
              <dd class="col-sm-8">${item_json.label}</dd>
            </dl>`
          );
          layer.bindTooltip(
            ("<div>" + feature.properties.item__label + "</div>"),
            { permanent: false, sticky: true }
          );
        };
      },
    },
    methods: {
      get_map_ref: function() {
        // console.log(this.$refs);
      },
      fit_bounds: function(){
        if(!this.geo_json){
          this.geo_json = GEO_JSON;
        }
        let l_geo_json = this.$refs[this.geojson_ref];
        if(l_geo_json == null){
          console.log('no: ' + this.geojson_ref);
          return null;
        }
        let bounds = l_geo_json.getBounds();
        this.$refs[this.map_ref].mapObject.fitBounds(bounds);
        console.log(bounds);
      },
    },
    components: {
      'l-popup': l_popup,
      'l-tile-layer': l_tile_layer,
      'l-geo-json': l_geo_json,
      'l-marker': l_marker,
      'l-map': l_map,
    },
});


const router = new VueRouter({
  mode: 'history',
  linkExactActiveClass: 'active',
  routes: [],
});


var vm = new Vue(
  {
    router: router,
    delimiters: ['[[', ']]'],
    ref: 'item_app',
    el: '#app',
    data: {
        uuid: ITEM_UUID,
    },
    computed: {
        act_route: function () {
            return this.$route;
        },
    },
    watch: {
        $route(to, from) {
        // react to route changes...
        }
    },
    methods: {
      
    },
    created() {

    },
    components: {
      'item_map': vc_item_map,
    },
  },
).$mount('#app');

</script>

